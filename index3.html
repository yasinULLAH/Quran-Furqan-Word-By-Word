<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: ltr; }
        .arabic-text, .arabic-word { font-family: 'KFGQPC Uthman Taha Naskh', 'Traditional Arabic', 'Al Mushaf', serif; font-size: 1.8rem; direction: rtl; line-height: 1.8; }
        .urdu-text, .urdu-word { font-family: 'Noto Nastaliq Urdu', 'Arial', sans-serif; font-size: 1.4rem; direction: rtl; line-height: 1.8;}
        .english-text { font-size: 1.1rem; line-height: 1.6; }
        .word-table td, .word-table th { text-align: center; vertical-align: middle; padding: 0.5rem; }
        .nav-tabs .nav-link.active { background-color: #343a40; color: white; border-color: #495057 #495057 #343a40; }
        .nav-tabs .nav-link { color: #adb5bd; }
        
        /* Styles for Block Mushaf View (Single Surah) */
        #quranFullView.block-style .ayah-block { margin-bottom: 1rem; padding: 0.5rem; border-bottom: 1px solid #495057; }
        #quranFullView.block-style .ayah-text-mushaf { text-align: justify; display: block; }
        #quranFullView.block-style .ayah-number-mushaf { font-size: 1rem; color: gold; padding: 0 0.3rem; display: block; text-align: right; }
        #quranFullView.block-style .bismillah-text-mushaf { display: block; text-align: center; margin-bottom: 1rem; font-weight: bold;}


        /* Styles for Flowing Text Mushaf View (Full Quran Continuous) */
        #quranFullView.flow-style { text-align: right; direction: rtl; }
        #quranFullView.flow-style .mushaf-ayah-text-flow { display: inline; }
        #quranFullView.flow-style .mushaf-ayah-number-flow { display: inline; color: gold; font-size: 0.8em; margin: 0 0.2em; }
        #quranFullView.flow-style .bismillah-text-mushaf { display: block; text-align: center; margin-bottom: 1rem; font-weight: bold; }
        #quranFullView.flow-style .surah-header-mushaf { display: block; text-align: center; font-size: 1.5em; font-weight: bold; margin: 2rem 0 1rem 0; border-top: 2px solid gold; border-bottom: 2px solid gold; padding: 0.5rem 0;}


        .search-results-item, #ayahIndexList li { cursor: pointer; padding: 0.5rem; border-bottom: 1px solid #495057; }
        .search-results-item:hover, #ayahIndexList li:hover { background-color: #495057; }
        #loadingIndicator, #progressIndicator {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(33, 37, 41, 0.9); color: white; padding: 25px; border-radius: 8px; z-index: 1060; display: none; text-align: center;
        }
        .form-control, .form-select { background-color: #2b3035; color: #e9ecef; border-color: #495057; }
        .form-control:focus, .form-select:focus { background-color: #343a40; color: #e9ecef; border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .table { color: #e9ecef; }
        textarea.form-control { min-height: 100px; }
        .btn-secondary { background-color: #495057; border-color: #495057; }
        .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; }
        .page-content { display: none; } 
        .page-content.active { display: block; } 
        .surah-title-arabic { font-family: 'KFGQPC Uthman Taha Naskh', 'Traditional Arabic', serif; font-size: 2rem; }
        #audioPlayerContainer { margin-top: 10px; }
        #quranFullView { font-size: 24px; padding:10px; border:1px solid #495057; border-radius:5px; margin-top:10px; max-height: 70vh; overflow-y: auto; position: relative; }
        .alertPlaceholderClass { position: fixed; top: 10px; right: 10px; z-index: 1055; width: 300px; }
        #ayahIndexViewContainer { border: 1px solid #495057; padding: 10px; margin-top: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto;}
        #mushafSentinel { height: 50px; } /* For intersection observer */
    </style>
</head>
<body>
    <div id="alertPlaceholder" class="alertPlaceholderClass"></div>
    <div id="loadingIndicator">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 mb-0">Loading initial data... Please wait.</p>
        <p><small>This may take a few moments on the first visit.</small></p>
    </div>
    <div id="progressIndicator">
        <p id="progressText" class="mb-1">Processing...</p>
        <div class="progress" style="height: 20px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
    </div>

    <div class="container-fluid mt-2">
        <header class="d-flex justify-content-between align-items-center mb-3 p-2 bg-dark text-white rounded">
            <h4 class="mb-0">Quran App</h4>
            <div class="d-flex align-items-center">
                <button id="toggleThemeBtn" class="btn btn-sm btn-outline-light me-2">Toggle Theme</button>
                <span id="currentSuraAyahDisplay" class="me-2"></span>
                <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas" aria-controls="settingsOffcanvas">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.858 2.929 2.929 0 0 1 0 5.858z"/></svg>
                </button>
            </div>
        </header>

        <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="ayah-view-tab" data-bs-toggle="tab" data-bs-target="#ayahViewPage" type="button" role="tab">Ayah View</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="mushaf-view-tab" data-bs-toggle="tab" data-bs-target="#mushafViewPage" type="button" role="tab">Mushaf View</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#searchPage" type="button" role="tab">Search</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="bookmarks-tab" data-bs-toggle="tab" data-bs-target="#bookmarksPage" type="button" role="tab">Bookmarks</button></li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <div class="tab-pane fade show active page-content" id="ayahViewPage" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="surahSelect" class="form-label">Surah:</label>
                        <select id="surahSelect" class="form-select"></select>
                    </div>
                    <div class="col-md-2">
                        <label for="ayahSelect" class="form-label">Ayah:</label>
                        <select id="ayahSelect" class="form-select"></select>
                    </div>
                    <div class="col-md-7 d-flex align-items-end">
                        <button id="prevAyahBtn" class="btn btn-secondary me-1 btn-sm">Prev</button>
                        <button id="nextAyahBtn" class="btn btn-secondary me-2 btn-sm">Next</button>
                         <button id="playAudioBtn" class="btn btn-info me-1 btn-sm">Play Audio</button>
                        <button id="bookmarkBtn" class="btn btn-warning me-1 btn-sm">Bookmark</button>
                        <button id="exportAyahBtn" class="btn btn-success btn-sm">Export Ayah</button>
                        <button id="toggleAyahIndexBtn" class="btn btn-outline-primary ms-auto btn-sm">Show Quran Index</button>
                    </div>
                </div>
                <div id="audioPlayerContainer" class="mb-2"> <audio id="audioPlayer" controls class="w-100"></audio> </div>
                <div id="wordByWordView" class="mb-3"> <h5>Word by Word:</h5> <div class="table-responsive"> <table class="table table-bordered table-hover word-table"> <thead><tr><th>Arabic</th><th>Urdu Meaning</th><th>English Meaning</th></tr></thead> <tbody id="wordTableBody"></tbody> </table> </div> </div>
                <div id="ayahTranslationView" class="mb-3"> <h5>Ayah Translations:</h5> <div class="card mb-2"> <div class="card-header">English Translation</div> <div class="card-body english-text" id="englishTranslation"></div> </div> <div class="card"> <div class="card-header urdu-text text-end">اردو ترجمہ</div> <div class="card-body urdu-text text-end" id="urduTranslation"></div> </div> </div>
                <div id="notesView" class="mb-3"> <h5>Notes for <span id="noteAyahIdentifier"></span>:</h5> <textarea id="noteText" class="form-control mb-2" placeholder="Take notes for this ayah..."></textarea> <button id="saveNoteBtn" class="btn btn-primary btn-sm">Save Note</button> </div>
                <div id="statsView" class="mt-3"> <h5>Statistics:</h5> <p id="surahStats"></p> </div>
                
                <div id="ayahIndexViewContainer" style="display: none;">
                    <h5>Quran Ayah Index (Paginated)</h5>
                    <ul id="ayahIndexList" class="list-group mb-2"></ul>
                    <div id="ayahIndexPaginationControls" class="d-flex justify-content-between align-items-center">
                        <button id="prevAyahIndexPageBtn" class="btn btn-outline-secondary btn-sm">Previous</button>
                        <span id="ayahIndexPageInfo">Page X of Y</span>
                        <button id="nextAyahIndexPageBtn" class="btn btn-outline-secondary btn-sm">Next</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade page-content" id="mushafViewPage" role="tabpanel">
                <div class="row mb-3 align-items-center">
                    <div class="col-md-3">
                        <label for="mushafViewModeSelect" class="form-label">View Mode:</label>
                        <select id="mushafViewModeSelect" class="form-select form-select-sm">
                            <option value="singleSurah">Single Surah</option>
                            <option value="fullQuran">Full Quran (Continuous)</option>
                        </select>
                    </div>
                    <div id="mushafSurahSelectorContainer" class="col-md-3">
                        <label for="mushafSurahSelect" class="form-label">Select Surah:</label>
                        <select id="mushafSurahSelect" class="form-select form-select-sm"></select>
                    </div>
                    <div class="col-md-6 d-flex justify-content-end align-items-center">
                         <h4 id="mushafSurahName" class="text-center surah-title-arabic mb-0 me-auto"></h4>
                        <button id="toggleFullscreenBtn" class="btn btn-outline-light btn-sm">Toggle Fullscreen</button>
                    </div>
                </div>
                 <div id="quranFullView" class="arabic-text block-style"> Select a Surah to display. <div id="mushafSentinel"></div> </div>
            </div>

            <div class="tab-pane fade page-content" id="searchPage" role="tabpanel"> <div class="input-group mb-3"> <input type="text" id="searchInput" class="form-control" placeholder="Search Arabic, Urdu, English text or Surah:Ayah (e.g., 1:1)"> <button id="searchBtn" class="btn btn-primary">Search</button> </div> <div id="searchResultsSpinner" class="text-center" style="display: none;"> <div class="spinner-border" role="status"><span class="visually-hidden">Searching...</span></div> </div> <div id="searchResultsInfo" class="mb-2"></div> <ul id="searchResultsList" class="list-group"></ul> </div>
            <div class="tab-pane fade page-content" id="bookmarksPage" role="tabpanel"> <h4>Bookmarked Ayahs</h4> <ul id="bookmarksList" class="list-group"></ul> </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="settingsOffcanvas" aria-labelledby="settingsOffcanvasLabel"> <div class="offcanvas-header"> <h5 class="offcanvas-title" id="settingsOffcanvasLabel">Settings</h5> <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button> </div> <div class="offcanvas-body"> <div class="mb-3"> <label for="mushafFontSizeRange" class="form-label">Mushaf Font Size: <span id="mushafFontSizeValue">24</span>px</label> <input type="range" class="form-range" min="16" max="48" step="1" id="mushafFontSizeRange" value="24"> </div> <div class="mb-3 form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="showWordByWordToggle" checked> <label class="form-check-label" for="showWordByWordToggle">Show Word-by-Word Table</label> </div> <div class="mb-3 form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="showAyahTranslationToggle" checked> <label class="form-check-label" for="showAyahTranslationToggle">Show Ayah Translations</label> </div> <button id="clearAllDataBtn" class="btn btn-danger mt-3">Clear All Local Data & Reload</button> <p class="mt-2"><small>Clearing data will remove words, bookmarks, and notes. Data will be re-fetched on reload.</small></p> </div> </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Constants and Global Variables ---
        const DB_NAME = 'QuranAppDB_v3z'; // Incremented version for schema/major changes
        const DB_VERSION = 1; 
        const WORDS_STORE = 'words';
        const BOOKMARKS_STORE = 'bookmarks';
        const NOTES_STORE = 'notes';
        const DATA_FILE_URL = './data5.AM'; 
        const WORD_MAP_URL = './word.AM'; 
        let db1;
        let currentSurah = 1, currentAyah = 1;
        // let currentMushafSurah = 1; // Replaced by mushafViewMode logic
        let surahMaxAyahs = [0, 7, 286, 200, 176, 120, 165, 206, 75, 129, 109, 123, 111, 43, 52, 99, 128, 111, 110, 98, 135, 112, 78, 118, 64, 77, 227, 93, 88, 69, 60, 34, 30, 73, 54, 45, 83, 182, 88, 75, 85, 54, 53, 89, 59, 37, 35, 38, 29, 18, 45, 60, 49, 62, 55, 78, 96, 29, 22, 24, 13, 14, 11, 11, 18, 12, 12, 30, 52, 52, 44, 28, 28, 20, 56, 40, 31, 50, 40, 46, 42, 29, 19, 36, 25, 22, 17, 19, 26, 30, 20, 15, 21, 11, 8, 8, 19, 5, 8, 8, 11, 11, 8, 3, 9, 5, 4, 7, 3, 6, 3, 5, 4, 5, 6];
        const surahNames = ["", "Al-Fatiha", "Al-Baqarah", "Aal-e-Imran", "An-Nisa", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus", "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Ta-Ha", "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum", "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir", "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf", "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah", "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad", "Ash-Shams", "Al-Layl", "Ad-Duha", "Ash-Sharh", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-Adiyat", "Al-Qari'ah", "At-Takathur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr", "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"];
        const surahNamesArabic = ["", "ٱلْفَاتِحَة", "ٱلْبَقَرَة", "آلِ عِمْرَان", "ٱلنِّسَاء", "ٱلْمَائِدَة", "ٱلْأَنْعَام", "ٱلْأَعْرَاف", "ٱلْأَنْفَال", "ٱلتَّوْبَة", "يُونُس", "هُود", "يُوسُف", "ٱلرَّعْد", "إِبْرَاهِيم", "ٱلْحِجْر", "ٱلنَّحْل", "ٱلْإِسْرَاء", "ٱلْكَهْف", "مَرْيَم", "طه", "ٱلْأَنْبِيَاء", "ٱلْحَجّ", "ٱلْمُؤْمِنُونَ", "ٱلنُّور", "ٱلْفُرْقَان", "ٱلشُّعَرَاء", "ٱلنَّمْل", "ٱلْقَصَص", "ٱلْعَنْكَبُوت", "ٱلرُّوم", "لُقْمَان", "ٱلسَّجْدَة", "ٱلْأَحْزَاب", "سَبَأ", "فَاطِر", "يس", "ٱلصَّافَّات", "ص", "ٱلزُّمَر", "غَافِر", "فُصِّلَتْ", "ٱلشُّورَىٰ", "ٱلزُّخْرُف", "ٱلدُّخَان", "ٱلْجَاثِيَة", "ٱلْأَحْقَاف", "مُحَمَّد", "ٱلْفَتْح", "ٱلْحُجُرَات", "ق", "ٱلذَّارِيَات", "ٱلطُّور", "ٱلنَّجْم", "ٱلْقَمَر", "ٱلرَّحْمَٰن", "ٱلْوَاقِعَة", "ٱلْحَدِيد", "ٱلْمُجَادِلَة", "ٱلْحَشْر", "ٱلْﻤُمْتَحَنَة", "ٱلصَّفّ", "ٱلْجُمُعَة", "ٱلْمُنَافِقُونَ", "ٱلتَّغَابُن", "ٱلطَّلَاق", "ٱلتَّحْرِيم", "ٱلْمُلْك", "ٱلْقَلَم", "ٱلْحَاقَّة", "ٱلْمَعَارِج", "نُوح", "ٱلْجِنّ", "ٱلْمُزَّمِّل", "ٱلْمُدَّثِّر", "ٱلْقِيَامَة", "ٱلْإِنْسَان", "ٱلْمُرْسَلَات", "ٱلنَّبَأ", "ٱلنَّازِعَات", "عَبَسَ", "ٱلتَّكْوِير", "ٱلْإِنْفِطَار", "ٱلْمُطَفِّفِين", "ٱلْإِنْشِقَاق", "ٱلْبُرُوج", "ٱلطَّارِق", "ٱلْأَعْلَىٰ", "ٱلْغَاشِيَة", "ٱلْفَجْر", "ٱلْبَلَد", "ٱلشَّمْس", "ٱللَّيْل", "ٱلضُّحَىٰ", "ٱلشَّرْح", "ٱلتِّين", "ٱلْعَلَق", "ٱلْقَدْر", "ٱلْبَيِّنَة", "ٱلزَّلْزَلَة", "ٱلْعَادِيَات", "ٱلْقَارِعَة", "ٱلتَّكَاثُر", "ٱلْعَصْر", "ٱلْهُمَزَة", "ٱلْفِيل", "قُرَيْش", "ٱلْمَاعُون", "ٱلْكَوْثَر", "ٱلْكَافِرُونَ", "ٱلنَّصْر", "ٱلْمَسَد", "ٱلْإِخْلَاص", "ٱلْفَلَق", "ٱلنَّاس"];
        const BISMILLAH_TEXT = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";
        let totalGlobalAyahs = 0;

        // --- Ayah Index State ---
        let ayahIndexState = { isActive: false, currentPage: 1, itemsPerPage: 30, totalPages: 0 };
        
        // --- Mushaf Continuous Scroll State ---
        let mushafContinuousState = { isActive: false, currentSurah: 1, currentAyahInSurah: 0, globalAyahsRendered: 0, isLoadingChunk: false, allAyahsRendered: false };
        const MUSHAF_CHUNK_SIZE = 100; // Load 100 global ayahs at a time
        let mushafIntersectionObserver = null;


        // --- DOM Elements (shortened) ---
        const gebi = id => document.getElementById(id);
        const sS = () => gebi('surahSelect'); const aS = () => gebi('ayahSelect');
        const wTB = () => gebi('wordTableBody'); const eT = () => gebi('englishTranslation');
        const uT = () => gebi('urduTranslation'); const bmBtn = () => gebi('bookmarkBtn');
        const nTxt = () => gebi('noteText'); const sNBtn = () => gebi('saveNoteBtn');
        const nAI = () => gebi('noteAyahIdentifier'); const bmList = () => gebi('bookmarksList');
        const srchIn = () => gebi('searchInput'); const srchBtn = () => gebi('searchBtn');
        const srchResList = () => gebi('searchResultsList'); const srchResInfo = () => gebi('searchResultsInfo');
        const srchSpin = () => gebi('searchResultsSpinner'); const audPlyr = () => gebi('audioPlayer');
        const pABtn = () => gebi('playAudioBtn'); const lI = () => gebi('loadingIndicator');
        const pI = () => gebi('progressIndicator'); const pTxt = () => gebi('progressText');
        const pBar = () => gebi('progressBar'); 
        const mSS = () => gebi('mushafSurahSelect'); const qFV = () => gebi('quranFullView');
        const mFSN = () => gebi('mushafSurahName'); const mFSR = () => gebi('mushafFontSizeRange');
        const mFSV = () => gebi('mushafFontSizeValue'); const cSAD = () => gebi('currentSuraAyahDisplay');
        const sStats = () => gebi('surahStats'); const sWByWToggle = () => gebi('showWordByWordToggle');
        const sATToggle = () => gebi('showAyahTranslationToggle'); const wByWView = () => gebi('wordByWordView');
        const aTView = () => gebi('ayahTranslationView'); const alertPlcHldr = () => gebi('alertPlaceholder');
        const tAIBtn = () => gebi('toggleAyahIndexBtn'); const aIVC = () => gebi('ayahIndexViewContainer');
        const aIList = () => gebi('ayahIndexList'); const aIPagiCtrls = () => gebi('ayahIndexPaginationControls');
        const prevAIPBtn = () => gebi('prevAyahIndexPageBtn'); const nextAIPBtn = () => gebi('nextAyahIndexPageBtn');
        const aIPInfo = () => gebi('ayahIndexPageInfo');
        const mVMSel = () => gebi('mushafViewModeSelect'); const mSSC = () => gebi('mushafSurahSelectorContainer');
        const tFSBtn = () => gebi('toggleFullscreenBtn'); const mSent = () => gebi('mushafSentinel');


        const _log = console.log; const _err = console.error; const _warn = console.warn;

        // --- Helper Functions --- (showAlert, removeArabicDiacritics, formatAyahRef as before)
        function showAlert(msg, type = 'info') { const placeholder = alertPlcHldr(); if (!placeholder) { _warn('Alert placeholder not found.'); return; } const wrapper = document.createElement('div'); wrapper.innerHTML = [ `<div class="alert alert-${type} alert-dismissible fade show" role="alert" style="min-width: 250px;">`, `   <div>${msg}</div>`, '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>', '</div>' ].join(''); placeholder.append(wrapper.firstChild); setTimeout(() => { const alertDiv = placeholder.querySelector('.alert'); if (alertDiv) new bootstrap.Alert(alertDiv).close(); }, 5000); }
        function removeArabicDiacritics(txt) { if (typeof txt !== 'string') return ''; return txt.replace(/[\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E8\u06EA-\u06ED]/g, ''); }
        function formatAyahRef(s, a) { return `${s}:${a}`; }
        function calculateTotalGlobalAyahs() { totalGlobalAyahs = surahMaxAyahs.slice(1).reduce((acc, count) => acc + count, 0); }
        function getSurahAyahFromGlobalIndex(globalIdx) { let cumulativeAyahs = 0; for (let s = 1; s < surahMaxAyahs.length; s++) { if (globalIdx <= cumulativeAyahs + surahMaxAyahs[s]) { const ayah = globalIdx - cumulativeAyahs; return { surah: s, ayah: ayah }; } cumulativeAyahs += surahMaxAyahs[s]; } return null; }
        function getGlobalIndexFromSurahAyah(targetSurah, targetAyah) { let globalIdx = 0; for (let s = 1; s < targetSurah; s++) { globalIdx += surahMaxAyahs[s]; } globalIdx += targetAyah; return globalIdx; }


        // --- IndexedDB Functions --- (initDB, checkAndLoadInitialData, postDataLoadSetup, populateWordsStore as before, with minor keyPath change if needed)
        function initDB() { /* ... identical to previous version, ensure WORDS_STORE keyPath: 'idGlobal' ... */ return new Promise((res, rej) => { lI().style.display = 'flex'; const req = indexedDB.open(DB_NAME, DB_VERSION); req.onupgradeneeded = e => { db1 = e.target.result; if (!db1.objectStoreNames.contains(WORDS_STORE)) { const wStore = db1.createObjectStore(WORDS_STORE, { keyPath: 'idGlobal' }); wStore.createIndex('surah_ayah_position', ['surah', 'ayah', 'position'], { unique: false }); wStore.createIndex('surah_ayah', ['surah', 'ayah'], { unique: false }); wStore.createIndex('surah', 'surah', { unique: false }); } if (!db1.objectStoreNames.contains(BOOKMARKS_STORE)) { const bmStore = db1.createObjectStore(BOOKMARKS_STORE, { keyPath: 'id', autoIncrement: true }); bmStore.createIndex('surah_ayah', 'surah_ayah', { unique: true }); } if (!db1.objectStoreNames.contains(NOTES_STORE)) { db1.createObjectStore(NOTES_STORE, { keyPath: 'surah_ayah' }); } _log('DB upgrade needed/completed'); }; req.onsuccess = e => { db1 = e.target.result; _log('DB initialized'); res(db1); }; req.onerror = e => { _err('DB error:', e.target.error); showAlert('Error initializing database: ' + e.target.error.message, 'danger'); lI().style.display = 'none'; rej(e.target.error); }; }); }
        async function checkAndLoadInitialData() { /* ... identical to previous version with regex parsing for word.AM ... */ try { const tx = db1.transaction(WORDS_STORE, 'readonly'); const store = tx.objectStore(WORDS_STORE); const countReq = store.count(); countReq.onsuccess = async () => { if (countReq.result > 70000) { _log('Data already loaded.'); lI().style.display = 'none'; await postDataLoadSetup(); } else { _log('No data or partial data. Loading from files...'); lI().style.display = 'none';  pI().style.display = 'block'; pTxt().textContent = 'Fetching data files...'; try { const [quranDataRes, wordMapRes] = await Promise.all([ fetch(DATA_FILE_URL).catch(e => { throw new Error(`Failed to fetch ${DATA_FILE_URL}: ${e.message}`) }),  fetch(WORD_MAP_URL).catch(e => { throw new Error(`Failed to fetch ${WORD_MAP_URL}: ${e.message}`)}) ]); if (!quranDataRes.ok) throw new Error(`HTTP error for ${DATA_FILE_URL}! status: ${quranDataRes.status}`); if (!wordMapRes.ok) throw new Error(`HTTP error for ${WORD_MAP_URL}! status: ${wordMapRes.status}`); const quranDataText = await quranDataRes.text(); const wordMapText = await wordMapRes.text(); const parsedWordMap = {}; const regex = /"(\d+)":\s*\{\s*"surah":\s*(\d+),\s*"ayah":\s*(\d+),\s*"position":\s*(\d+)\s*\}/g; let matchRegex; while ((matchRegex = regex.exec(wordMapText)) !== null) { parsedWordMap[matchRegex[1]] = { surah: parseInt(matchRegex[2]), ayah: parseInt(matchRegex[3]), position: parseInt(matchRegex[4]) }; } if (Object.keys(parsedWordMap).length === 0 && wordMapText.length > 50) { _err("word.AM parsing with regex failed."); showAlert("Critical Error: word.AM parsing failed.", "danger"); pI().style.display = 'none'; return;  } pTxt().textContent = 'Processing and storing data...'; await populateWordsStore(quranDataText, parsedWordMap); _log('Data loaded successfully.'); pI().style.display = 'none'; await postDataLoadSetup(); } catch (err) { _err('Error loading initial data:', err); showAlert('Error loading initial data: ' + err.message, 'danger'); pI().style.display = 'none'; lI().style.display = 'none'; } } }; countReq.onerror = (e) => { _err('Error counting words:', e.target.error); showAlert('Error accessing database.', 'danger'); lI().style.display = 'none'; } } catch (err) { _err('DB transaction error for count:', err); showAlert('Database access error: ' + err.message, 'danger'); lI().style.display = 'none'; } }
        async function postDataLoadSetup() { calculateTotalGlobalAyahs(); populateSurahDropdowns(); updateAyahDropdown(); loadAyahView(currentSurah, currentAyah); loadBookmarks(); setupMushafView(); applySettings(); }
        async function populateWordsStore(qData, wMap) { /* ... identical to previous version ... */ const lines = qData.trim().split('\n'); const dataEntries = lines.slice(1);  const totalEntries = dataEntries.length; let successfullyAdded = 0; const tx = db1.transaction(WORDS_STORE, 'readwrite'); const store = tx.objectStore(WORDS_STORE); return new Promise((resolve, reject) => { if (totalEntries === 0) { _warn("No data entries in data5.AM."); pTxt().textContent = 'No data in data5.AM.'; setTimeout(() => { pI().style.display = 'none'; resolve(); }, 1000); return; } dataEntries.forEach((line, index) => { const parts = line.split(','); if (parts.length < 3) { _warn('Skipping malformed line in data5.AM:', line); return;  } const [quran_text, ur_meaning, en_meaning] = parts.map(p => p.trim()); const wordIdGlobalStr = String(index + 1);  const metadata = wMap[wordIdGlobalStr]; if (metadata && quran_text) {  const wordEntry = { idGlobal: parseInt(wordIdGlobalStr),  quran_text: quran_text, ur_meaning: ur_meaning || "",  en_meaning: en_meaning || "", surah: parseInt(metadata.surah), ayah: parseInt(metadata.ayah), position: parseInt(metadata.position) }; const req = store.add(wordEntry); req.onsuccess = () => { successfullyAdded++; const percentComplete = Math.round((successfullyAdded / totalEntries) * 100); pBar().style.width = percentComplete + '%'; pBar().textContent = percentComplete + '%'; }; req.onerror = (e) => { if (e.target.error.name === 'ConstraintError') { _err(`ConstraintError adding word ID ${wordIdGlobalStr}.`, wordEntry, e.target.error); } else { _warn(`Error adding word ID ${wordIdGlobalStr}:`, e.target.error); } }; } else { _warn('Skipping entry due to missing metadata/quran_text. Word ID:', wordIdGlobalStr); } }); tx.oncomplete = () => { _log(`${successfullyAdded} of ${totalEntries} words added.`); pTxt().textContent = 'Data processing complete!'; setTimeout(() => { pI().style.display = 'none'; resolve(); }, 500); }; tx.onerror = e => { _err('Transaction error populating words store:', e.target.error); showAlert('Error saving data: ' + e.target.error.message, 'danger'); pI().style.display = 'none'; reject(e.target.error); }; });}

        // --- UI Population and Display Logic (Ayah View - Single) --- (populateSurahDropdowns, updateAyahDropdown, loadAyahView, displayWordByWord, generateAndDisplayAyahTranslations - mostly as before)
        function populateSurahDropdowns() { /* ... identical ... */ [sS(), mSS()].forEach(select => { if (!select) return; select.innerHTML = ''; for (let i = 1; i <= 114; i++) { const opt = document.createElement('option'); opt.value = i; opt.textContent = `${i}. ${surahNames[i]}`; select.appendChild(opt); } }); if(sS()) sS().value = currentSurah; if(mSS()) mSS().value = 1; /* Default to surah 1 for mushaf single view */ }
        function updateAyahDropdown() { /* ... identical ... */ const maxAyahs = surahMaxAyahs[currentSurah] || 0;  if(aS()) { aS().innerHTML = ''; if (maxAyahs > 0) { for (let i = 1; i <= maxAyahs; i++) { const opt = document.createElement('option'); opt.value = i; opt.textContent = i; aS().appendChild(opt); } if (currentAyah > maxAyahs || currentAyah < 1) currentAyah = 1; aS().value = currentAyah; } else { const opt = document.createElement('option'); opt.textContent = "-"; aS().appendChild(opt); }} }
        async function loadAyahView(suraNum, ayahNum) { /* ... identical ... */ if (!db1) { showAlert('Database not ready.', 'warning'); return; } currentSurah = parseInt(suraNum); currentAyah = parseInt(ayahNum); if (sS().value != currentSurah) sS().value = currentSurah; updateAyahDropdown();  if(cSAD()) cSAD().textContent = `Surah ${surahNames[currentSurah]} (${currentSurah}), Ayah ${currentAyah}`; const tx = db1.transaction(WORDS_STORE, 'readonly'); const store = tx.objectStore(WORDS_STORE); const index = store.index('surah_ayah_position'); const range = IDBKeyRange.bound([currentSurah, currentAyah, 0], [currentSurah, currentAyah, Infinity]); const words = []; index.openCursor(range).onsuccess = e => { const cursor = e.target.result; if (cursor) { words.push(cursor.value); cursor.continue(); } else { displayWordByWord(words); generateAndDisplayAyahTranslations(words); loadNote(); updateBookmarkButtonStatus(); updateAudioPlayerSource(); calculateSurahStats(currentSurah); } }; tx.onerror = e => _err('Error fetching ayah data:', e.target.error); }
        function displayWordByWord(words) { /* ... identical ... */ if(!wTB()) return; wTB().innerHTML = ''; if (words.length === 0) { wTB().innerHTML = '<tr><td colspan="3">No data.</td></tr>'; return; } words.sort((a,b) => a.position - b.position).forEach(w => { const row = wTB().insertRow(); row.insertCell().textContent = w.quran_text; row.cells[0].classList.add('arabic-word'); row.insertCell().textContent = w.ur_meaning; row.cells[1].classList.add('urdu-word'); row.insertCell().textContent = w.en_meaning; }); }
        function generateAndDisplayAyahTranslations(words) { /* ... identical ... */ let enTrans = words.sort((a,b)=>a.position - b.position).map(w => w.en_meaning.replace(/[()]/g, '')).join(' ').trim(); let urTrans = words.sort((a,b)=>a.position - b.position).map(w => w.ur_meaning.replace(/[()]/g, '')).join(' ').trim(); if (enTrans) enTrans = enTrans.charAt(0).toUpperCase() + enTrans.slice(1) + '.'; else enTrans = "N/A."; if (urTrans) urTrans += '۔'; else urTrans = "N/A"; if(eT()) eT().textContent = enTrans; if(uT()) uT().textContent = urTrans; }

        // --- Ayah Index (Paginated List in Ayah View) ---
        function toggleAyahIndexView() {
            ayahIndexState.isActive = !ayahIndexState.isActive;
            if (aIVC()) aIVC().style.display = ayahIndexState.isActive ? 'block' : 'none';
            if (tAIBtn()) tAIBtn().textContent = ayahIndexState.isActive ? 'Hide Quran Index' : 'Show Quran Index';
            if (ayahIndexState.isActive && totalGlobalAyahs > 0) {
                ayahIndexState.totalPages = Math.ceil(totalGlobalAyahs / ayahIndexState.itemsPerPage);
                renderAyahIndexPage(ayahIndexState.currentPage);
            }
        }

        function renderAyahIndexPage(page) {
            if (!db1 || !aIList() || !aIPInfo()) return;
            ayahIndexState.currentPage = Math.max(1, Math.min(page, ayahIndexState.totalPages));
            aIList().innerHTML = ''; // Clear previous list

            const startGlobalIdx = (ayahIndexState.currentPage - 1) * ayahIndexState.itemsPerPage + 1;
            const endGlobalIdx = Math.min(startGlobalIdx + ayahIndexState.itemsPerPage - 1, totalGlobalAyahs);

            for (let i = startGlobalIdx; i <= endGlobalIdx; i++) {
                const item = getSurahAyahFromGlobalIndex(i);
                if (item) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-action';
                    li.textContent = `${surahNames[item.surah]} ${item.surah}:${item.ayah} (Global: ${i})`;
                    li.dataset.surah = item.surah;
                    li.dataset.ayah = item.ayah;
                    li.onclick = () => {
                        loadAyahView(item.surah, item.ayah);
                        // Optional: scroll to top of Ayah View if needed
                        gebi('ayahViewPage').scrollTop = 0;
                    };
                    aIList().appendChild(li);
                }
            }
            aIPInfo().textContent = `Page ${ayahIndexState.currentPage} of ${ayahIndexState.totalPages}`;
            if(prevAIPBtn()) prevAIPBtn().disabled = ayahIndexState.currentPage === 1;
            if(nextAIPBtn()) nextAIPBtn().disabled = ayahIndexState.currentPage === ayahIndexState.totalPages;
        }
        
        // --- Mushaf View Logic ---
        function setupMushafView() {
            const mode = mVMSel() ? mVMSel().value : 'singleSurah';
            if (mode === 'singleSurah') {
                mushafContinuousState.isActive = false;
                if(mushafIntersectionObserver) mushafIntersectionObserver.disconnect();
                if(mSSC()) mSSC().style.display = 'block'; // Show Surah selector
                if(qFV()) qFV().className = 'arabic-text block-style'; // Set style for single surah
                loadSingleMushafSurah(parseInt(mSS().value) || 1);
            } else { // fullQuran mode
                mushafContinuousState.isActive = true;
                if(mSSC()) mSSC().style.display = 'none'; // Hide Surah selector
                if(mFSN()) mFSN().textContent = "Full Quran View";
                if(qFV()) {
                    qFV().innerHTML = ''; // Clear previous content
                    qFV().className = 'arabic-text flow-style'; // Set style for flowing text
                    const sentinel = mSent(); // Ensure sentinel is there
                    if (!sentinel) {
                        const newSentinel = document.createElement('div');
                        newSentinel.id = 'mushafSentinel';
                        qFV().appendChild(newSentinel);
                    }
                }
                resetMushafContinuousState();
                loadNextMushafChunk(true); // Initial load
                initializeMushafIntersectionObserver();
            }
        }
        
        function resetMushafContinuousState() {
            mushafContinuousState.currentSurah = 1;
            mushafContinuousState.currentAyahInSurah = 0;
            mushafContinuousState.globalAyahsRendered = 0;
            mushafContinuousState.isLoadingChunk = false;
            mushafContinuousState.allAyahsRendered = false;
            if(qFV()) qFV().scrollTop = 0; // Scroll to top
        }

        async function loadSingleMushafSurah(suraNum) { // Renamed from loadMushafSurah
            if (!db1 || !qFV()) return;
            qFV().innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Loading Surah...</p></div>';
            if(mFSN()) mFSN().textContent = surahNamesArabic[suraNum] ? `${surahNamesArabic[suraNum]} (${surahNames[suraNum]})` : 'Select Surah';

            const tx = db1.transaction(WORDS_STORE, 'readonly');
            const store = tx.objectStore(WORDS_STORE);
            const index = store.index('surah_ayah_position'); 
            const range = IDBKeyRange.bound([suraNum, 0, 0], [suraNum, Infinity, Infinity]); 
            const ayahs = {}; 
            index.openCursor(range).onsuccess = e => {
                const cursor = e.target.result;
                if (cursor) {
                    const word = cursor.value;
                    if (!ayahs[word.ayah]) ayahs[word.ayah] = [];
                    ayahs[word.ayah].push({text: word.quran_text, position: word.position});
                    cursor.continue();
                } else {
                    for (const ayahNum in ayahs) {
                        ayahs[ayahNum] = ayahs[ayahNum].sort((a, b) => a.position - b.position).map(w => w.text).join(' ');
                    }
                    renderSingleSurahMushaf(ayahs, suraNum);
                }
            };
            tx.onerror = e => { _err('Error fetching single surah for Mushaf:', e.target.error); if(qFV()) qFV().innerHTML = '<p class="text-danger">Error loading Surah.</p>'; };
        }

        function renderSingleSurahMushaf(ayahsData, suraNum) {
            if (!qFV()) return;
            qFV().innerHTML = ''; qFV().className = 'arabic-text block-style'; // Ensure correct class
            if (Object.keys(ayahsData).length === 0 && suraNum) { qFV().innerHTML = `<p>No text for Surah ${surahNames[suraNum]}.</p>`; return; }

            if (suraNum !== 1 && suraNum !== 9) { 
                 const bDiv = document.createElement('div'); bDiv.className = 'bismillah-text-mushaf'; bDiv.textContent = BISMILLAH_TEXT; qFV().appendChild(bDiv);
            }
            const fragment = document.createDocumentFragment();
            const sortedAyahNums = Object.keys(ayahsData).map(Number).sort((a, b) => a - b);
            for (const ayahNum of sortedAyahNums) {
                const ayahText = ayahsData[ayahNum];
                const ayahDiv = document.createElement('div'); ayahDiv.className = 'ayah-block'; 
                const textSpan = document.createElement('span'); textSpan.className = 'ayah-text-mushaf'; textSpan.textContent = ayahText;
                const numSpan = document.createElement('span'); numSpan.className = 'ayah-number-mushaf'; numSpan.textContent = `﴿${ayahNum.toLocaleString('ar-EG')}﴾`; 
                ayahDiv.appendChild(textSpan); ayahDiv.appendChild(numSpan); fragment.appendChild(ayahDiv);
            }
            qFV().appendChild(fragment);
            const sentinel = mSent() || document.createElement('div'); sentinel.id = 'mushafSentinel'; qFV().appendChild(sentinel); // Ensure sentinel is at the end
            applyMushafFontSize(); 
        }
        
        async function loadNextMushafChunk(isInitialLoad = false) {
            if (!db1 || mushafContinuousState.isLoadingChunk || mushafContinuousState.allAyahsRendered || !mushafContinuousState.isActive) return;
            mushafContinuousState.isLoadingChunk = true;
            if (isInitialLoad && qFV()) qFV().innerHTML = ''; // Clear for fresh full Quran load

            let ayahsToRender = [];
            let ayahsCountInChunk = 0;
            let tempCurrentSurah = mushafContinuousState.currentSurah;
            let tempCurrentAyahInSurah = mushafContinuousState.currentAyahInSurah;
            
            const tx = db1.transaction(WORDS_STORE, 'readonly');
            const store = tx.objectStore(WORDS_STORE);
            const index = store.index('surah_ayah_position');

            // Add Surah Header for the very first load
            if (isInitialLoad && tempCurrentSurah === 1 && tempCurrentAyahInSurah === 0) {
                 const surahHeader = document.createElement('div');
                 surahHeader.className = 'surah-header-mushaf';
                 surahHeader.textContent = `${surahNamesArabic[1]} (${surahNames[1]})`;
                 ayahsToRender.push({type: 'surahHeader', element: surahHeader});
            }


            while (tempCurrentSurah <= 114 && ayahsCountInChunk < MUSHAF_CHUNK_SIZE) {
                if (tempCurrentAyahInSurah === 0) { // Start of a new surah
                    if (tempCurrentSurah !== 1 && tempCurrentSurah !== 9) { // Add Bismillah
                        const bDiv = document.createElement('div'); bDiv.className = 'bismillah-text-mushaf'; bDiv.textContent = BISMILLAH_TEXT;
                        ayahsToRender.push({ type: 'bismillah', element: bDiv });
                    }
                    // Add Surah Header if it's not the very first surah on initial load (handled above)
                    if (!isInitialLoad || tempCurrentSurah > 1) {
                         const surahHeader = document.createElement('div');
                         surahHeader.className = 'surah-header-mushaf';
                         surahHeader.textContent = `${surahNamesArabic[tempCurrentSurah]} (${surahNames[tempCurrentSurah]})`;
                         ayahsToRender.push({type: 'surahHeader', element: surahHeader});
                    }
                }

                tempCurrentAyahInSurah++;
                if (tempCurrentAyahInSurah > surahMaxAyahs[tempCurrentSurah]) {
                    tempCurrentSurah++;
                    tempCurrentAyahInSurah = 0; // Reset for new surah, loop will handle Bismillah/header
                    if (tempCurrentSurah > 114) { mushafContinuousState.allAyahsRendered = true; break; }
                    continue; 
                }

                // Fetch words for this specific ayah
                const range = IDBKeyRange.bound([tempCurrentSurah, tempCurrentAyahInSurah, 0], [tempCurrentSurah, tempCurrentAyahInSurah, Infinity]);
                const wordsForAyah = [];
                // This needs to be async or handled differently within a loop.
                // For simplicity here, we'll assume a structure that can be synchronously built up for rendering.
                // A more robust way: collect {s,a} list, then fetch all words in one go or series of promises.
                // For now, let's design for rendering collected data:
                // We need to fetch words for each ayah to form its text.

                const ayahWords = await new Promise((resolveWords) => {
                    const tempWords = [];
                    const cursorReq = index.openCursor(range);
                    cursorReq.onsuccess = e => {
                        const cursor = e.target.result;
                        if (cursor) { tempWords.push(cursor.value); cursor.continue(); } 
                        else { resolveWords(tempWords.sort((a,b)=>a.position-b.position).map(w=>w.quran_text).join(' ')); }
                    };
                    cursorReq.onerror = () => resolveWords(""); // Empty on error
                });

                if (ayahWords) {
                    const textSpan = document.createElement('span'); textSpan.className = 'mushaf-ayah-text-flow'; textSpan.textContent = ayahWords;
                    const numSpan = document.createElement('span'); numSpan.className = 'mushaf-ayah-number-flow'; numSpan.textContent = `﴿${tempCurrentAyahInSurah.toLocaleString('ar-EG')}﴾`;
                    ayahsToRender.push({ type: 'ayah', textEl: textSpan, numEl: numSpan });
                    ayahsCountInChunk++;
                    mushafContinuousState.globalAyahsRendered++;
                }
                
                mushafContinuousState.currentSurah = tempCurrentSurah;
                mushafContinuousState.currentAyahInSurah = tempCurrentAyahInSurah;

                if (mushafContinuousState.globalAyahsRendered >= totalGlobalAyahs) {
                    mushafContinuousState.allAyahsRendered = true;
                    break;
                }
            }
            
            renderMushafChunk(ayahsToRender);
            mushafContinuousState.isLoadingChunk = false;
            if (mushafContinuousState.allAyahsRendered && mushafIntersectionObserver) {
                mushafIntersectionObserver.disconnect();
                _log("All Quran ayahs rendered in continuous mode.");
            }
        }

        function renderMushafChunk(elementsToRender) {
            if (!qFV()) return;
            const fragment = document.createDocumentFragment();
            elementsToRender.forEach(item => {
                if (item.type === 'bismillah' || item.type === 'surahHeader') {
                    fragment.appendChild(item.element);
                } else if (item.type === 'ayah') {
                    fragment.appendChild(item.textEl);
                    fragment.appendChild(item.numEl);
                }
            });
            const sentinel = mSent(); // Detach sentinel if exists
            if(sentinel) sentinel.remove();
            qFV().appendChild(fragment);
            if(sentinel && !mushafContinuousState.allAyahsRendered) qFV().appendChild(sentinel); // Re-attach sentinel
            applyMushafFontSize();
        }

        function initializeMushafIntersectionObserver() {
            if (mushafIntersectionObserver) mushafIntersectionObserver.disconnect();
            const options = { root: qFV(), rootMargin: '0px', threshold: 0.1 };
            mushafIntersectionObserver = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !mushafContinuousState.isLoadingChunk && !mushafContinuousState.allAyahsRendered) {
                    _log("Sentinel visible, loading next Mushaf chunk...");
                    loadNextMushafChunk();
                }
            }, options);
            const sentinel = mSent();
            if (sentinel) mushafIntersectionObserver.observe(sentinel);
        }


        function applyMushafFontSize() { /* ... identical to previous version, ensure qFV styling is applied ... */ const size = mFSR() ? mFSR().value : 24; if (qFV()) { qFV().style.fontSize = `${size}px`; qFV().style.lineHeight = `${Math.max(1.8, size / 13)}`;  } if (mFSV()) mFSV().textContent = size; localStorage.setItem('mushafFontSize', size); const bismillahDivs = document.querySelectorAll('#quranFullView .bismillah-text-mushaf, #quranFullView .surah-header-mushaf'); bismillahDivs.forEach(div => { div.style.fontSize = `${size * (div.classList.contains('surah-header-mushaf') ? 1.2 : 1)}px`; }); }
        function toggleFullScreenMushaf() { const elem = qFV(); if (!elem) return; if (!document.fullscreenElement) { elem.requestFullscreen().catch(err => { showAlert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`, 'warning'); }); } else { if (document.exitFullscreen) { document.exitFullscreen(); } } }
        
        // --- Core Functionalities (Bookmarks, Notes, Search, Audio, Export, Stats) --- (mostly as before, ensure robustness)
        function navigateAyah(direction) { /* ... identical to previous, using currentSurah, currentAyah ... */ let newSurah = currentSurah; let newAyah = currentAyah; if (direction === 'next') { if (newAyah < surahMaxAyahs[newSurah]) { newAyah++; } else if (newSurah < 114) { newSurah++; newAyah = 1; } else { showAlert('End of Quran.', 'info'); return; }  } else if (direction === 'prev') { if (newAyah > 1) { newAyah--; } else if (newSurah > 1) { newSurah--; newAyah = surahMaxAyahs[newSurah]; } else { showAlert('Start of Quran.', 'info'); return; }  } loadAyahView(newSurah, newAyah); }
        async function toggleBookmark() { /* ... identical ... */ if (!db1) return; const suraAyahStr = formatAyahRef(currentSurah, currentAyah); const tx = db1.transaction(BOOKMARKS_STORE, 'readwrite'); const store = tx.objectStore(BOOKMARKS_STORE); const index = store.index('surah_ayah'); const req = index.get(suraAyahStr); req.onsuccess = e => { const existing = e.target.result; if (existing) {  store.delete(existing.id).onsuccess = () => { showAlert('Bookmark removed.', 'info'); updateBookmarkButtonStatus(false); loadBookmarks();  }; } else {  store.add({ surah_ayah: suraAyahStr, surah: currentSurah, ayah: currentAyah, name: surahNames[currentSurah] }).onsuccess = () => { showAlert('Ayah bookmarked!', 'success'); updateBookmarkButtonStatus(true); loadBookmarks();  }; } }; req.onerror = e => _err('Error accessing bookmark:', e.target.error); }
        async function updateBookmarkButtonStatus(isBookmarked) { /* ... identical ... */ if (isBookmarked === undefined) {  if (!db1 || !bmBtn()) { if(bmBtn()) {bmBtn().textContent = 'Bookmark'; bmBtn().classList.remove('btn-danger'); bmBtn().classList.add('btn-warning');} return; } const suraAyahStr = formatAyahRef(currentSurah, currentAyah); const tx = db1.transaction(BOOKMARKS_STORE, 'readonly'); const store = tx.objectStore(BOOKMARKS_STORE); const index = store.index('surah_ayah'); index.get(suraAyahStr).onsuccess = e => { const B = !!e.target.result; if(bmBtn()){ bmBtn().textContent = B ? 'Unbookmark' : 'Bookmark'; bmBtn().classList.toggle('btn-danger', B); bmBtn().classList.toggle('btn-warning', !B);} }; } else { if(bmBtn()){ bmBtn().textContent = isBookmarked ? 'Unbookmark' : 'Bookmark'; bmBtn().classList.toggle('btn-danger', isBookmarked); bmBtn().classList.toggle('btn-warning', !isBookmarked);} } }
        function loadBookmarks() { /* ... identical ... */ if (!db1 || !bmList()) return; const tx = db1.transaction(BOOKMARKS_STORE, 'readonly'); const store = tx.objectStore(BOOKMARKS_STORE); bmList().innerHTML = ''; store.openCursor().onsuccess = e => { const cursor = e.target.result; if (cursor) { const bm = cursor.value; const li = document.createElement('li'); li.className = 'list-group-item d-flex justify-content-between align-items-center'; li.textContent = `S${bm.surah}:${bm.ayah} (${surahNames[bm.surah]})`; li.dataset.surah = bm.surah; li.dataset.ayah = bm.ayah; li.onclick = () => { loadAyahView(parseInt(bm.surah), parseInt(bm.ayah)); const ayahViewTab = gebi('ayah-view-tab'); if(ayahViewTab) new bootstrap.Tab(ayahViewTab).show(); }; const delBtn = document.createElement('button'); delBtn.className = 'btn btn-sm btn-outline-danger'; delBtn.innerHTML = '&times;'; delBtn.setAttribute('aria-label', 'Remove'); delBtn.onclick = (ev) => { ev.stopPropagation(); removeBookmark(bm.id); }; li.appendChild(delBtn); bmList().appendChild(li); cursor.continue(); } else { if (bmList().children.length === 0) { bmList().innerHTML = '<li class="list-group-item">No bookmarks.</li>'; } } }; }
        function removeBookmark(bookmarkId) { /* ... identical ... */ if (!db1) return; const tx = db1.transaction(BOOKMARKS_STORE, 'readwrite'); tx.objectStore(BOOKMARKS_STORE).delete(bookmarkId).onsuccess = () => { showAlert('Bookmark removed.', 'info'); loadBookmarks();  updateBookmarkButtonStatus();  }; }
        function loadNote() { /* ... identical ... */ if (!db1) return; const suraAyahStr = formatAyahRef(currentSurah, currentAyah); if (nAI()) nAI().textContent = `${surahNames[currentSurah]} (${suraAyahStr})`; const tx = db1.transaction(NOTES_STORE, 'readonly'); tx.objectStore(NOTES_STORE).get(suraAyahStr).onsuccess = e => { if (nTxt()) nTxt().value = e.target.result ? e.target.result.text : ''; }; }
        function saveNote() { /* ... identical ... */ if (!db1) return; const suraAyahStr = formatAyahRef(currentSurah, currentAyah); const text = nTxt() ? nTxt().value.trim() : ""; const tx = db1.transaction(NOTES_STORE, 'readwrite'); const store = tx.objectStore(NOTES_STORE); if (text) { store.put({ surah_ayah: suraAyahStr, text: text }).onsuccess = () => showAlert('Note saved!', 'success'); } else {  store.delete(suraAyahStr).onsuccess = () => showAlert('Note cleared.', 'info'); } tx.onerror = e => showAlert('Error saving note: '+ e.target.error.message, 'danger'); }
        async function performSearch() { /* ... identical ... */ if (!db1) { showAlert('DB not ready.', 'warning'); return; } const query = srchIn()? srchIn().value.trim() : ""; if (!query) { if(srchResList()) srchResList().innerHTML = ''; if(srchResInfo()) srchResInfo().textContent = 'Enter search term.'; return; } if(srchSpin()) srchSpin().style.display = 'block'; if(srchResList()) srchResList().innerHTML = ''; if(srchResInfo()) srchResInfo().textContent = 'Searching...'; const saMatch = query.match(/^(\d{1,3}):(\d{1,3})$/); if (saMatch) { const s = parseInt(saMatch[1]); const a = parseInt(saMatch[2]); if (s > 0 && s <= 114 && a > 0 && a <= surahMaxAyahs[s]) { if(srchSpin()) srchSpin().style.display = 'none'; if(srchResInfo()) srchResInfo().textContent = `Navigating to S${s}:A${a}.`; loadAyahView(s,a); const ayahViewTab = gebi('ayah-view-tab'); if(ayahViewTab) new bootstrap.Tab(ayahViewTab).show(); return; } else { if(srchSpin()) srchSpin().style.display = 'none'; if(srchResInfo()) srchResInfo().textContent = 'Invalid S:A.'; return; } } const results = new Map();  const lowerQuery = query.toLowerCase(); const normalizedArabicQuery = removeArabicDiacritics(query); const tx = db1.transaction(WORDS_STORE, 'readonly'); const store = tx.objectStore(WORDS_STORE); let itemsScanned = 0; let matchesFound = 0; store.openCursor().onsuccess = e => { const cursor = e.target.result; if (cursor) { itemsScanned++; const word = cursor.value; const saKey = formatAyahRef(word.surah, word.ayah); if (!results.has(saKey)) {  if ((word.quran_text && removeArabicDiacritics(word.quran_text).includes(normalizedArabicQuery)) || (word.ur_meaning && word.ur_meaning.toLowerCase().includes(lowerQuery)) || (word.en_meaning && word.en_meaning.toLowerCase().includes(lowerQuery))) { results.set(saKey, word); matchesFound++; } } if (itemsScanned % 5000 === 0) {  if(srchResInfo()) srchResInfo().textContent = `Scanned ${itemsScanned} words... Found ${matchesFound} ayahs.`; } cursor.continue(); } else {  if(srchSpin()) srchSpin().style.display = 'none'; if (results.size > 0) { if(srchResInfo()) srchResInfo().textContent = `Found ${results.size} ayahs matching "${query}".`; results.forEach((word, key) => { const [s, a] = key.split(':').map(Number); const li = document.createElement('li'); li.className = 'list-group-item search-results-item'; let context = word.quran_text;  if (word.en_meaning && word.en_meaning.toLowerCase().includes(lowerQuery)) context = word.en_meaning; else if (word.ur_meaning && word.ur_meaning.toLowerCase().includes(lowerQuery)) context = word.ur_meaning; li.textContent = `S${s}:${a} (${surahNames[s]}) - "...${context.substring(0,30)}..."`; li.dataset.surah = s; li.dataset.ayah = a; li.onclick = () => { loadAyahView(s,a); const ayahViewTab = gebi('ayah-view-tab'); if(ayahViewTab) new bootstrap.Tab(ayahViewTab).show(); }; if(srchResList()) srchResList().appendChild(li); }); } else { if(srchResInfo()) srchResInfo().textContent = `No results for "${query}". Scanned ${itemsScanned}.`; } } }; tx.onerror = e => { _err('Search error:', e.target.error); if(srchSpin()) srchSpin().style.display = 'none'; if(srchResInfo()) srchResInfo().textContent = 'Search error.'; showAlert('Search error: ' + e.target.error.message, 'danger'); }; }
        function updateAudioPlayerSource() { /* ... identical ... */ const apiUrl = `https://api.alquran.cloud/v1/ayah/${currentSurah}:${currentAyah}/ar.alafasy`; fetch(apiUrl).then(response => response.json()).then(data => { if (data.code === 200 && data.data.audio) { if(audPlyr()) audPlyr().src = data.data.audio; } else { _warn('Audio not found:', data.status); if(audPlyr()) audPlyr().removeAttribute('src'); showAlert('Audio not loaded.', 'warning'); } }).catch(err => { _err('Error fetching audio URL:', err); if(audPlyr()) audPlyr().removeAttribute('src'); showAlert('Failed to fetch audio.', 'danger'); }); }
        function exportAyahTranslations() { /* ... identical ... */ const enT = eT() ? eT().textContent : "N/A"; const urT = uT() ? uT().textContent : "N/A"; let content = `Ayah: Surah ${surahNames[currentSurah]} (${currentSurah}), Ayah ${currentAyah}\n\nEnglish:\n${enT}\n\nUrdu:\n${urT}\n\n`; const words = []; if (wTB()) { const rows = wTB().rows; for (let i = 0; i < rows.length; i++) { words.push({ ar: rows[i].cells[0] ? rows[i].cells[0].textContent : "", ur: rows[i].cells[1] ? rows[i].cells[1].textContent : "", en: rows[i].cells[2] ? rows[i].cells[2].textContent : "" }); } } if (words.length > 0) { content += "Word by Word:\nArabic | Urdu | English\n---------------------------\n"; words.forEach(w => { content += `${w.ar} | ${w.ur} | ${w.en}\n`; }); } const blob = new Blob([content], { type: 'text/plain;charset=utf-8' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `quran_ayah_${currentSurah}_${currentAyah}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); showAlert('Ayah data exported.', 'success'); }
        async function calculateSurahStats(suraNum) { /* ... identical ... */ if (!db1) { if(sStats()) sStats().textContent = 'DB not ready.'; return; } const tx = db1.transaction(WORDS_STORE, 'readonly'); const store = tx.objectStore(WORDS_STORE); const index = store.index('surah');  const range = IDBKeyRange.only(parseInt(suraNum)); const countReq = index.count(range); countReq.onsuccess = () => { const wordCount = countReq.result; if(sStats()) sStats().textContent = `Surah ${surahNames[suraNum]} has ${surahMaxAyahs[suraNum]} ayahs, ${wordCount} words.`; }; countReq.onerror = (e) => { _err('Error counting words for stats:', e.target.error); if(sStats()) sStats().textContent = 'Stats error.'; }; }
        function applySettings() { /* ... identical, ensure applyMushafFontSize is robust ... */ const savedFontSize = localStorage.getItem('mushafFontSize'); if (savedFontSize && mFSR()) { mFSR().value = savedFontSize; } applyMushafFontSize();  const showWbw = localStorage.getItem('showWordByWord') !== 'false';  const showAt = localStorage.getItem('showAyahTranslation') !== 'false';  if(sWByWToggle()) sWByWToggle().checked = showWbw; if(sATToggle()) sATToggle().checked = showAt; if(wByWView()) wByWView().style.display = showWbw ? '' : 'none'; if(aTView()) aTView().style.display = showAt ? '' : 'none'; const savedTheme = localStorage.getItem('theme') || 'dark';  document.documentElement.setAttribute('data-bs-theme', savedTheme); }
        function clearAllData() { /* ... identical ... */ if (confirm("Clear all local data? App will reload.")) { if(lI()){ lI().innerHTML = '<div class="spinner-border"></div><p>Clearing...</p>'; lI().style.display = 'flex';} const deleteReq = indexedDB.deleteDatabase(DB_NAME); deleteReq.onsuccess = () => { localStorage.clear(); showAlert('Data cleared. Reloading...', 'info'); setTimeout(() => window.location.reload(), 2000); }; deleteReq.onerror = (e) => { _err("Error deleting DB:", e.target.error); showAlert('Error clearing data.', 'danger'); if(lI()) lI().style.display = 'none'; }; deleteReq.onblocked = () => { _warn("DB deletion blocked."); showAlert('Deletion blocked. Close other tabs.', 'warning'); if(lI()) lI().style.display = 'none'; }; } }

        // --- Event Listeners ---
        window.onload = async () => {
            try {
                await initDB();
                await checkAndLoadInitialData(); 
            } catch (err) { _err("Initialization failed:", err); showAlert('App init failed.', 'danger'); if(lI()) lI().style.display = 'none'; }

            if(sS()) sS().onchange = () => { loadAyahView(parseInt(sS().value), 1); }; 
            if(aS()) aS().onchange = () => { loadAyahView(currentSurah, parseInt(aS().value)); };
            
            const prevBtn = gebi('prevAyahBtn'); if(prevBtn) prevBtn.onclick = () => navigateAyah('prev');
            const nextBtn = gebi('nextAyahBtn'); if(nextBtn) nextBtn.onclick = () => navigateAyah('next');
            
            if(bmBtn()) bmBtn().onclick = toggleBookmark;
            if(sNBtn()) sNBtn().onclick = saveNote;
            if(pABtn() && audPlyr()) pABtn().onclick = () => audPlyr().play().catch(e => showAlert("Audio play failed.", "warning"));
            const expBtn = gebi('exportAyahBtn'); if(expBtn) expBtn.onclick = exportAyahTranslations;

            if(srchBtn()) srchBtn().onclick = performSearch;
            if(srchIn()) srchIn().onkeyup = e => { if (e.key === 'Enter') performSearch(); };
            
            // Ayah Index Listeners
            if(tAIBtn()) tAIBtn().onclick = toggleAyahIndexView;
            if(prevAIPBtn()) prevAIPBtn().onclick = () => { if (ayahIndexState.currentPage > 1) renderAyahIndexPage(ayahIndexState.currentPage - 1); };
            if(nextAIPBtn()) nextAIPBtn().onclick = () => { if (ayahIndexState.currentPage < ayahIndexState.totalPages) renderAyahIndexPage(ayahIndexState.currentPage + 1); };

            // Mushaf View Listeners
            if(mVMSel()) mVMSel().onchange = setupMushafView;
            if(mSS()) mSS().onchange = () => { if (mVMSel().value === 'singleSurah') loadSingleMushafSurah(parseInt(mSS().value)); };
            if(tFSBtn()) tFSBtn().onclick = toggleFullScreenMushaf;

            if(mFSR()) { mFSR().oninput = applyMushafFontSize; mFSR().onchange = applyMushafFontSize; }
            
            if(sWByWToggle()) sWByWToggle().onchange = e => { if(wByWView()) wByWView().style.display = e.target.checked ? '' : 'none'; localStorage.setItem('showWordByWord', e.target.checked); };
            if(sATToggle()) sATToggle().onchange = e => { if(aTView()) aTView().style.display = e.target.checked ? '' : 'none'; localStorage.setItem('showAyahTranslation', e.target.checked); };
            const themeToggle = gebi('toggleThemeBtn'); if(themeToggle) themeToggle.onclick = () => { const newTheme = document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-bs-theme', newTheme); localStorage.setItem('theme', newTheme); };
            const clearBtn = gebi('clearAllDataBtn'); if(clearBtn) clearBtn.onclick = clearAllData;

            const mainTabs = gebi('mainTabs');
            if(mainTabs) mainTabs.addEventListener('shown.bs.tab', event => {
                const targetTabId = event.target.getAttribute('data-bs-target');
                if (targetTabId === '#bookmarksPage') loadBookmarks();
                else if (targetTabId === '#mushafViewPage') setupMushafView(); // Refresh/setup Mushaf view when tab is shown
                else if (targetTabId === '#ayahViewPage' && ayahIndexState.isActive) renderAyahIndexPage(ayahIndexState.currentPage); // Refresh index if active
            });
        };
    </script>
</body>
</html>