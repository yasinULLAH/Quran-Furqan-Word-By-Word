<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: ltr; font-size: 0.95rem;}
        .arabic-text, .arabic-word, .arabic-word-tooltipable { font-family: 'KFGQPC Uthman Taha Naskh', 'Traditional Arabic', 'Al Mushaf', serif; font-size: 1.8rem; direction: rtl; line-height: 2; }
        .urdu-text, .urdu-word { font-family: 'Noto Nastaliq Urdu', 'Arial', sans-serif; font-size: 1.4rem; direction: rtl; line-height: 1.8;}
        .english-text { font-size: 1.1rem; line-height: 1.6; }
        .word-table td, .word-table th { text-align: center; vertical-align: middle; padding: 0.4rem; }
        .nav-tabs .nav-link { font-size: 0.9rem; padding: 0.6rem 0.8rem;}
        .nav-tabs .nav-link.active { background-color: #343a40; color: white; border-color: #495057 #495057 #343a40; }
        .nav-tabs .nav-link { color: #adb5bd; }
        
        #ayahArabicTextWithTooltipsContainer { margin-bottom: 1rem; padding: 0.5rem; border: 1px solid #495057; border-radius: 0.25rem; direction: rtl; text-align: justify;}
        .arabic-word-tooltipable { cursor: help; padding: 0 0.1em; border-bottom: 1px dotted transparent;}
        .arabic-word-tooltipable:hover { background-color: rgba(255,255,255,0.1); border-bottom-color: gold; }

        #quranFullView.block-style .ayah-block { margin-bottom: 1rem; padding: 0.5rem; border-bottom: 1px solid #495057; }
        #quranFullView.block-style .ayah-text-mushaf { text-align: justify; display: block; }
        #quranFullView.block-style .ayah-number-mushaf { font-size: 1rem; color: gold; padding: 0 0.3rem; display: block; text-align: right; }
        #quranFullView.block-style .bismillah-text-mushaf { display: block; text-align: center; margin-bottom: 1rem; font-weight: bold;}

        #quranFullView.flow-style { text-align: right; direction: rtl; }
        #quranFullView.flow-style .mushaf-ayah-text-flow { display: inline; }
        #quranFullView.flow-style .mushaf-ayah-number-flow { display: inline; color: gold; font-size: 0.8em; margin: 0 0.2em; user-select: none;}
        #quranFullView.flow-style .bismillah-text-mushaf { display: block; text-align: center; margin: 1.5rem 0 1rem 0; font-weight: bold; }
        #quranFullView.flow-style .surah-header-mushaf { display: block; text-align: center; font-size: 1.5em; font-weight: bold; margin: 2rem 0 1rem 0; border-top: 2px solid gold; border-bottom: 2px solid gold; padding: 0.5rem 0;}

        .search-results-item, #ayahIndexList li { cursor: pointer; padding: 0.5rem; border-bottom: 1px solid #495057; }
        .search-results-item:hover, #ayahIndexList li:hover { background-color: #495057; }
        #loadingIndicator, #progressIndicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(33, 37, 41, 0.95); color: white; padding: 25px; border-radius: 8px; z-index: 1070; display: none; text-align: center; }
        .form-control, .form-select { background-color: #2b3035; color: #e9ecef; border-color: #495057; font-size:0.9rem; }
        .form-control:focus, .form-select:focus { background-color: #343a40; color: #e9ecef; border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .table { color: #e9ecef; }
        textarea.form-control { min-height: 80px; }
        .btn { font-size: 0.85rem; } .btn-sm {font-size: 0.75rem;}
        .page-content { display: none; } 
        .page-content.active { display: block; } 
        .surah-title-arabic { font-family: 'KFGQPC Uthman Taha Naskh', 'Traditional Arabic', serif; font-size: 1.8rem; }
        #audioPlayerContainer { margin-top: 10px; }
        #quranFullView { font-size: 24px; padding:10px; border:1px solid #495057; border-radius:5px; margin-top:10px; max-height: 70vh; overflow-y: auto; position: relative; background-color: #212529;}
        .alertPlaceholderClass { position: fixed; top: 10px; right: 10px; z-index: 1055; width: 300px; }
        #ayahIndexViewContainer { border: 1px solid #495057; padding: 10px; margin-top: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto;}
        #mushafSentinel { height: 50px; width:100%;} 
        .tooltip-inner { max-width: 300px !important; text-align: right !important; direction: rtl !important; background-color: #212529; border: 1px solid #495057;}
        .tooltip-arrow::before { border-bottom-color: #212529 !important; /* Or border-top-color depending on placement */ }
        .tooltip-urdu { font-family: 'Noto Nastaliq Urdu', Arial; font-size: 1.1em; }
        .tooltip-english { font-size: 0.9em; direction: ltr; text-align: left;}
    </style>
</head>
<body>
    <div id="alertPlaceholder" class="alertPlaceholderClass"></div>
    <div id="loadingIndicator"> <div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div> <p class="mt-2 mb-0">Loading initial data... Please wait.</p> <p><small>This may take a few moments on the first visit.</small></p> </div>
    <div id="progressIndicator"> <p id="progressText" class="mb-1">Processing...</p> <div class="progress" style="height: 20px;"> <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div> </div> </div>

    <div class="container-fluid mt-2">
        <header class="d-flex justify-content-between align-items-center mb-3 p-2 bg-dark text-white rounded shadow-sm">
            <h4 class="mb-0">Quran App</h4>
            <div class="d-flex align-items-center">
                <button id="toggleThemeBtn" class="btn btn-sm btn-outline-light me-2">Toggle Theme</button>
                <span id="currentSuraAyahDisplay" class="me-2 small"></span>
                <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas" aria-controls="settingsOffcanvas"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283-.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.858 2.929 2.929 0 0 1 0 5.858z"/></svg> </button>
            </div>
        </header>

        <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="ayah-view-tab" data-bs-toggle="tab" data-bs-target="#ayahViewPage" type="button" role="tab">Ayah View</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="mushaf-view-tab" data-bs-toggle="tab" data-bs-target="#mushafViewPage" type="button" role="tab">Mushaf View</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#searchPage" type="button" role="tab">Search</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="bookmarks-tab" data-bs-toggle="tab" data-bs-target="#bookmarksPage" type="button" role="tab">Bookmarks</button></li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <div class="tab-pane fade show active page-content" id="ayahViewPage" role="tabpanel">
                <div class="row mb-2">
                    <div class="col-md-3 mb-2"><label for="surahSelect" class="form-label mb-1">Surah:</label><select id="surahSelect" class="form-select form-select-sm"></select></div>
                    <div class="col-md-2 mb-2"><label for="ayahSelect" class="form-label mb-1">Ayah:</label><select id="ayahSelect" class="form-select form-select-sm"></select></div>
                    <div class="col-md-7 mb-2 d-flex align-items-end flex-wrap">
                        <button id="prevAyahBtn" class="btn btn-secondary btn-sm me-1 mb-1">Prev</button>
                        <button id="nextAyahBtn" class="btn btn-secondary btn-sm me-2 mb-1">Next</button>
                        <button id="playAudioBtn" class="btn btn-info btn-sm me-1 mb-1">Play Audio</button>
                        <button id="bookmarkBtn" class="btn btn-warning btn-sm me-1 mb-1">Bookmark</button>
                        <button id="exportAyahBtn" class="btn btn-success btn-sm mb-1">Export Ayah</button>
                        <button id="toggleAyahIndexBtn" class="btn btn-outline-primary btn-sm ms-auto mb-1">Show Quran Index</button>
                    </div>
                </div>
                <div id="ayahArabicTextWithTooltipsContainer" class="arabic-text"></div>
                <div id="audioPlayerContainer" class="mb-2"> <audio id="audioPlayer" controls class="w-100" style="height: 40px;"></audio> </div>
                <div id="wordByWordView" class="mb-3"><h5>Word by Word:</h5><div class="table-responsive"><table class="table table-sm table-bordered table-hover word-table"><thead><tr><th>Arabic</th><th>Urdu</th><th>English</th></tr></thead><tbody id="wordTableBody"></tbody></table></div></div>
                <div id="ayahTranslationView" class="mb-3"><h5>Ayah Translations:</h5><div class="card mb-2"><div class="card-header py-1">English Translation</div><div class="card-body py-2 english-text" id="englishTranslation"></div></div><div class="card"><div class="card-header py-1 urdu-text text-end">اردو ترجمہ</div><div class="card-body py-2 urdu-text text-end" id="urduTranslation"></div></div></div>
                <div id="notesView" class="mb-3"><h5>Notes for <span id="noteAyahIdentifier" class="small"></span>:</h5><textarea id="noteText" class="form-control form-control-sm mb-2" placeholder="Take notes..."></textarea><button id="saveNoteBtn" class="btn btn-primary btn-sm">Save Note</button></div>
                <div id="statsView" class="mt-3 small"><h6 class="mb-1">Statistics:</h6><p id="surahStats" class="mb-1"></p></div>
                <div id="ayahIndexViewContainer" style="display: none;"> <h5 class="mt-2">Quran Ayah Index</h5> <ul id="ayahIndexList" class="list-group list-group-flush mb-2"></ul> <div id="ayahIndexPaginationControls" class="d-flex justify-content-between align-items-center"> <button id="prevAyahIndexPageBtn" class="btn btn-outline-secondary btn-sm">Previous</button> <span id="ayahIndexPageInfo" class="small">Page X of Y</span> <button id="nextAyahIndexPageBtn" class="btn btn-outline-secondary btn-sm">Next</button> </div> </div>
            </div>

            <div class="tab-pane fade page-content" id="mushafViewPage" role="tabpanel">
                <div class="row mb-2 align-items-center">
                    <div class="col-md-3 mb-1"><label for="mushafViewModeSelect" class="form-label mb-1">View Mode:</label><select id="mushafViewModeSelect" class="form-select form-select-sm"><option value="singleSurah">Single Surah</option><option value="fullQuran">Full Quran (Continuous)</option></select></div>
                    <div id="mushafSurahSelectorContainer" class="col-md-3 mb-1"><label for="mushafSurahSelect" class="form-label mb-1">Surah:</label><select id="mushafSurahSelect" class="form-select form-select-sm"></select></div>
                    <div class="col-md-6 mb-1 d-flex justify-content-end align-items-center"><h4 id="mushafSurahName" class="surah-title-arabic mb-0 me-auto text-truncate"></h4><button id="toggleFullscreenBtn" class="btn btn-outline-light btn-sm">Fullscreen</button></div>
                </div>
                <div id="quranFullView" class="arabic-text block-style">Select a Surah to display.</div>
            </div>

            <div class="tab-pane fade page-content" id="searchPage" role="tabpanel"> <div class="input-group mb-3"> <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search Arabic, Urdu, English text or Surah:Ayah (e.g., 1:1)"> <button id="searchBtn" class="btn btn-primary btn-sm">Search</button> </div> <div id="searchResultsSpinner" class="text-center" style="display: none;"> <div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Searching...</span></div> </div> <div id="searchResultsInfo" class="mb-2 small"></div> <ul id="searchResultsList" class="list-group list-group-flush"></ul> </div>
            <div class="tab-pane fade page-content" id="bookmarksPage" role="tabpanel"> <h4>Bookmarked Ayahs</h4> <ul id="bookmarksList" class="list-group list-group-flush"></ul> </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="settingsOffcanvas" aria-labelledby="settingsOffcanvasLabel"> <div class="offcanvas-header"> <h5 class="offcanvas-title" id="settingsOffcanvasLabel">Settings</h5> <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button> </div> <div class="offcanvas-body"> <div class="mb-3"> <label for="mushafFontSizeRange" class="form-label">Mushaf Font Size: <span id="mushafFontSizeValue">24</span>px</label> <input type="range" class="form-range" min="16" max="48" step="1" id="mushafFontSizeRange" value="24"> </div> <div class="mb-3 form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="showWordByWordToggle" checked> <label class="form-check-label" for="showWordByWordToggle">Show Word Table</label> </div> <div class="mb-3 form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="showAyahTranslationToggle" checked> <label class="form-check-label" for="showAyahTranslationToggle">Show Ayah Translations</label> </div> <button id="clearAllDataBtn" class="btn btn-danger mt-3 btn-sm">Clear All Local Data & Reload</button> <p class="mt-2 small"><small>Clearing data will remove words, bookmarks, and notes. Data will be re-fetched on reload.</small></p> </div> </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const DB_NAME = 'QuranAppDB_v4'; 
        const DB_VERSION = 1; 
        const WORDS_STORE = 'words'; const BOOKMARKS_STORE = 'bookmarks'; const NOTES_STORE = 'notes';
        const DATA_FILE_URL = './data5.AM'; const WORD_MAP_URL = './word2.AM'; 
        let db1; let currentSurah = 1, currentAyah = 1;
        let surahMaxAyahs = [0, 7, 286, 200, 176, 120, 165, 206, 75, 129, 109, 123, 111, 43, 52, 99, 128, 111, 110, 98, 135, 112, 78, 118, 64, 77, 227, 93, 88, 69, 60, 34, 30, 73, 54, 45, 83, 182, 88, 75, 85, 54, 53, 89, 59, 37, 35, 38, 29, 18, 45, 60, 49, 62, 55, 78, 96, 29, 22, 24, 13, 14, 11, 11, 18, 12, 12, 30, 52, 52, 44, 28, 28, 20, 56, 40, 31, 50, 40, 46, 42, 29, 19, 36, 25, 22, 17, 19, 26, 30, 20, 15, 21, 11, 8, 8, 19, 5, 8, 8, 11, 11, 8, 3, 9, 5, 4, 7, 3, 6, 3, 5, 4, 5, 6];
        const surahNames = ["", "Al-Fatiha", "Al-Baqarah", "Aal-e-Imran", "An-Nisa", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus", "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Ta-Ha", "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum", "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir", "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf", "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah", "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad", "Ash-Shams", "Al-Layl", "Ad-Duha", "Ash-Sharh", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-Adiyat", "Al-Qari'ah", "At-Takathur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr", "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"];
        const surahNamesArabic = ["", "ٱلْفَاتِحَة", "ٱلْبَقَرَة", "آلِ عِمْرَان", "ٱلنِّسَاء", "ٱلْمَائِدَة", "ٱلْأَنْعَام", "ٱلْأَعْرَاف", "ٱلْأَنْفَال", "ٱلتَّوْبَة", "يُونُس", "هُود", "يُوسُف", "ٱلرَّعْد", "إِبْرَاهِيم", "ٱلْحِجْر", "ٱلنَّحْل", "ٱلْإِسْرَاء", "ٱلْكَهْف", "مَرْيَم", "طه", "ٱلْأَنْبِيَاء", "ٱلْحَجّ", "ٱلْمُؤْمِنُونَ", "ٱلنُّور", "ٱلْفُرْقَان", "ٱلشُّعَرَاء", "ٱلنَّمْل", "ٱلْقَصَص", "ٱلْعَنْكَبُوت", "ٱلرُّوم", "لُقْمَان", "ٱلسَّجْدَة", "ٱلْأَحْزَاب", "سَبَأ", "فَاطِر", "يس", "ٱلصَّافَّات", "ص", "ٱلزُّمَر", "غَافِر", "فُصِّلَتْ", "ٱلشُّورَىٰ", "ٱلزُّخْرُف", "ٱلدُّخَان", "ٱلْجَاثِيَة", "ٱلْأَحْقَاف", "مُحَمَّد", "ٱلْفَتْح", "ٱلْحُجُرَات", "ق", "ٱلذَّارِيَات", "ٱلطُّور", "ٱلنَّجْم", "ٱلْقَمَر", "ٱلرَّحْمَٰن", "ٱلْوَاقِعَة", "ٱلْحَدِيد", "ٱلْمُجَادِلَة", "ٱلْحَشْر", "ٱلْﻤُمْتَحَنَة", "ٱلصَّفّ", "ٱلْجُمُعَة", "ٱلْمُنَافِقُونَ", "ٱلتَّغَابُن", "ٱلطَّلَاق", "ٱلتَّحْرِيم", "ٱلْمُلْك", "ٱلْقَلَم", "ٱلْحَاقَّة", "ٱلْمَعَارِج", "نُوح", "ٱلْجِنّ", "ٱلْمُزَّمِّل", "ٱلْمُدَّثِّر", "ٱلْقِيَامَة", "ٱلْإِنْسَان", "ٱلْمُرْسَلَات", "ٱلنَّبَأ", "ٱلنَّازِعَات", "عَبَسَ", "ٱلتَّكْوِير", "ٱلْإِنْفِطَار", "ٱلْمُطَفِّفِين", "ٱلْإِنْشِقَاق", "ٱلْبُرُوج", "ٱلطَّارِق", "ٱلْأَعْلَىٰ", "ٱلْغَاشِيَة", "ٱلْفَجْر", "ٱلْبَلَد", "ٱلشَّمْس", "ٱللَّيْل", "ٱلضُّحَىٰ", "ٱلشَّرْح", "ٱلتِّين", "ٱلْعَلَق", "ٱلْقَدْر", "ٱلْبَيِّنَة", "ٱلزَّلْزَلَة", "ٱلْعَادِيَات", "ٱلْقَارِعَة", "ٱلتَّكَاثُر", "ٱلْعَصْر", "ٱلْهُمَزَة", "ٱلْفِيل", "قُرَيْش", "ٱلْمَاعُون", "ٱلْكَوْثَر", "ٱلْكَافِرُونَ", "ٱلنَّصْر", "ٱلْمَسَد", "ٱلْإِخْلَاص", "ٱلْفَلَق", "ٱلنَّاس"];
        const BISMILLAH_TEXT = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";
        let totalGlobalAyahs = 0;
        let ayahIndexState = { isActive: false, currentPage: 1, itemsPerPage: 30, totalPages: 0 };
        let mushafContinuousState = { isActive: false, currentSurah: 1, currentAyahInSurah: 0, globalAyahsRendered: 0, isLoadingChunk: false, allAyahsRendered: false };
        const MUSHAF_CHUNK_SIZE = 100; 
        let mushafIntersectionObserver = null;
        let wordDataForTooltips = []; // To store words of current ayah for tooltips

        const gebi = id => document.getElementById(id);
        const sS = () => gebi('surahSelect'); const aS = () => gebi('ayahSelect');
        const wTB = () => gebi('wordTableBody'); const eT = () => gebi('englishTranslation');
        const uT = () => gebi('urduTranslation'); const bmBtn = () => gebi('bookmarkBtn');
        const nTxt = () => gebi('noteText'); const sNBtn = () => gebi('saveNoteBtn');
        const nAI = () => gebi('noteAyahIdentifier'); const bmList = () => gebi('bookmarksList');
        const srchIn = () => gebi('searchInput'); const srchBtn = () => gebi('searchBtn');
        const srchResList = () => gebi('searchResultsList'); const srchResInfo = () => gebi('searchResultsInfo');
        const srchSpin = () => gebi('searchResultsSpinner'); const audPlyr = () => gebi('audioPlayer');
        const pABtn = () => gebi('playAudioBtn'); const lI = () => gebi('loadingIndicator');
        const pI = () => gebi('progressIndicator'); const pTxt = () => gebi('progressText');
        const pBar = () => gebi('progressBar'); 
        const mSS = () => gebi('mushafSurahSelect'); const qFV = () => gebi('quranFullView');
        const mFSN = () => gebi('mushafSurahName'); const mFSR = () => gebi('mushafFontSizeRange');
        const mFSV = () => gebi('mushafFontSizeValue'); const cSAD = () => gebi('currentSuraAyahDisplay');
        const sStats = () => gebi('surahStats'); const sWByWToggle = () => gebi('showWordByWordToggle');
        const sATToggle = () => gebi('showAyahTranslationToggle'); const wByWView = () => gebi('wordByWordView');
        const aTView = () => gebi('ayahTranslationView'); const alertPlcHldr = () => gebi('alertPlaceholder');
        const tAIBtn = () => gebi('toggleAyahIndexBtn'); const aIVC = () => gebi('ayahIndexViewContainer');
        const aIList = () => gebi('ayahIndexList'); const aIPagiCtrls = () => gebi('ayahIndexPaginationControls');
        const prevAIPBtn = () => gebi('prevAyahIndexPageBtn'); const nextAIPBtn = () => gebi('nextAyahIndexPageBtn');
        const aIPInfo = () => gebi('ayahIndexPageInfo');
        const mVMSel = () => gebi('mushafViewModeSelect'); const mSSC = () => gebi('mushafSurahSelectorContainer');
        const tFSBtn = () => gebi('toggleFullscreenBtn'); 
        const aATTCont = () => gebi('ayahArabicTextWithTooltipsContainer');

        const _log = m => console.log(m); const _err = m => console.error(m); const _warn = m => console.warn(m);

        function showAlert(msg, type = 'info') { const ph = alertPlcHldr(); if (!ph) {_warn('Alert placeholder missing.'); return;} const wr = document.createElement('div'); wr.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert" style="min-width:250px;"><div>${msg}</div><button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button></div>`; ph.append(wr.firstChild); setTimeout(() => {const ad = ph.querySelector('.alert'); if(ad) new bootstrap.Alert(ad).close();}, 5000); }
        function removeArabicDiacritics(txt) { if (typeof txt !== 'string') return ''; return txt.replace(/[\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E8\u06EA-\u06ED]/g, ''); }
        function formatAyahRef(s, a) { return `${s}:${a}`; }
        function calculateTotalGlobalAyahs() { totalGlobalAyahs = surahMaxAyahs.slice(1).reduce((acc, count) => acc + count, 0); }
        function getSurahAyahFromGlobalIndex(globalIdx) { let cumAyahs = 0; for (let s = 1; s < surahMaxAyahs.length; s++) { if (globalIdx <= cumAyahs + surahMaxAyahs[s]) { return { surah: s, ayah: globalIdx - cumAyahs }; } cumAyahs += surahMaxAyahs[s]; } return null; }
        
        function initDB() { return new Promise((res, rej) => { lI().style.display = 'flex'; const req = indexedDB.open(DB_NAME, DB_VERSION); req.onupgradeneeded = e => { db1 = e.target.result; if (!db1.objectStoreNames.contains(WORDS_STORE)) { const ws = db1.createObjectStore(WORDS_STORE, { keyPath: 'idGlobal' }); ws.createIndex('s_a_p', ['surah', 'ayah', 'position']); ws.createIndex('s_a', ['surah', 'ayah']); ws.createIndex('s', 'surah'); } if (!db1.objectStoreNames.contains(BOOKMARKS_STORE)) { const bms = db1.createObjectStore(BOOKMARKS_STORE, { keyPath: 'id', autoIncrement: true }); bms.createIndex('s_a', 'surah_ayah', { unique: true }); } if (!db1.objectStoreNames.contains(NOTES_STORE)) { db1.createObjectStore(NOTES_STORE, { keyPath: 'surah_ayah' }); } _log('DB upgraded'); }; req.onsuccess = e => { db1 = e.target.result; _log('DB init'); res(db1); }; req.onerror = e => { _err('DB error: '+e.target.error); showAlert('DB init error: ' + e.target.error.message, 'danger'); lI().style.display = 'none'; rej(e.target.error); }; }); }
        async function checkAndLoadInitialData() { try { const tx = db1.transaction(WORDS_STORE, 'readonly'); const store = tx.objectStore(WORDS_STORE); const countReq = store.count(); countReq.onsuccess = async () => { if (countReq.result > 70000) { _log('Data loaded.'); lI().style.display = 'none'; await postDataLoadSetup(); } else { _log('No/partial data. Loading...'); lI().style.display = 'none'; pI().style.display = 'block'; pTxt().textContent = 'Fetching files...'; try { const [qDR, wMR] = await Promise.all([fetch(DATA_FILE_URL).catch(e=> {throw new Error(`Workspace ${DATA_FILE_URL} fail: ${e.message}`)}), fetch(WORD_MAP_URL).catch(e=> {throw new Error(`Workspace ${WORD_MAP_URL} fail: ${e.message}`)})]); if (!qDR.ok) throw new Error(`HTTP ${DATA_FILE_URL}: ${qDR.status}`); if (!wMR.ok) throw new Error(`HTTP ${WORD_MAP_URL}: ${wMR.status}`); const qDT = await qDR.text(); const wMT = await wMR.text(); const pWM = {}; const wMLs = wMT.trim().split('\n'); const wMH = wMLs[0].split(',').map(h=>h.trim()); const wDI=wMH.indexOf('word_id'), sI=wMH.indexOf('surah'), aI=wMH.indexOf('ayah'), pI_w=wMH.indexOf('word_postion'); for(let i=1; i<wMLs.length; i++){ const pts=wMLs[i].split(','); if(pts.length>=4){pWM[pts[wDI].trim()]={surah:parseInt(pts[sI]),ayah:parseInt(pts[aI]),position:parseInt(pts[pI_w])};}else{_warn('Skip word.AM line:',wMLs[i]);}} if(Object.keys(pWM).length===0&&wMT.length>50){_err("word.AM parse fail."); showAlert("word.AM parse fail.", "danger"); pI().style.display='none';return;} pTxt().textContent='Processing...'; await populateWordsStore(qDT,pWM); _log('Data loaded successfully.'); pI().style.display='none'; await postDataLoadSetup();} catch (err) { _err('Initial load error: '+err); showAlert('Initial load error: ' + err.message, 'danger'); pI().style.display='none'; lI().style.display='none'; } } }; countReq.onerror = e => { _err('Word count error: '+e.target.error); showAlert('DB access error.', 'danger'); lI().style.display='none';}} catch (err) { _err('DB tx error: '+err); showAlert('DB access error: ' + err.message, 'danger'); lI().style.display='none';}}
        async function postDataLoadSetup() { calculateTotalGlobalAyahs(); populateSurahDropdowns(); updateAyahDropdown(); loadAyahView(currentSurah, currentAyah); loadBookmarks(); setupMushafView(); applySettings(); }
        async function populateWordsStore(qD, wM) { const lines = qD.trim().split('\n'); const dataEntries = lines.slice(1); const totalEntries = dataEntries.length; let added = 0; const tx = db1.transaction(WORDS_STORE, 'readwrite'); const store = tx.objectStore(WORDS_STORE); return new Promise((res, rej) => { if (totalEntries===0) {pTxt().textContent='No data in data5.AM.';setTimeout(()=>{pI().style.display='none';res();},1000);return;} dataEntries.forEach((line,idx) => { const parts=line.split(','); if(parts.length<3){_warn('Skip data5.AM line:',line);return;} const [qt,um,em]=parts.map(p=>p.trim()); const wIGS=String(idx+1); const md=wM[wIGS]; if(md&&qt){const we={idGlobal:parseInt(wIGS),quran_text:qt,ur_meaning:um||"",en_meaning:em||"",surah:parseInt(md.surah),ayah:parseInt(md.ayah),position:parseInt(md.position)}; const req=store.add(we); req.onsuccess=()=>{added++; const pc=Math.round((added/totalEntries)*100); pBar().style.width=pc+'%';pBar().textContent=pc+'%';}; req.onerror=e=>{if(e.target.error.name==='ConstraintError'){_err(`ConstraintError ID ${wIGS}.`,we,e.target.error);}else{_warn(`Error add ID ${wIGS}:`,e.target.error);}}; }else{_warn('Skip entry, missing md/qt. ID:',wIGS);}}); tx.oncomplete=()=>{_log(`${added}/${totalEntries} words added.`);pTxt().textContent='Data process complete!';setTimeout(()=>{pI().style.display='none';res();},500);}; tx.onerror=e=>{_err('Tx error populate: '+e.target.error);showAlert('Error saving data: '+e.target.error.message,'danger');pI().style.display='none';rej(e.target.error);};});}
        function populateSurahDropdowns() { [sS(),mSS()].forEach(sel=>{if(!sel)return;sel.innerHTML='';for(let i=1;i<=114;i++){const o=document.createElement('option');o.value=i;o.textContent=`${i}. ${surahNames[i]}`;sel.appendChild(o);}}); if(sS())sS().value=currentSurah; if(mSS())mSS().value=1;}
        function updateAyahDropdown() {const maxA=surahMaxAyahs[currentSurah]||0;if(aS()){aS().innerHTML='';if(maxA>0){for(let i=1;i<=maxA;i++){const o=document.createElement('option');o.value=i;o.textContent=i;aS().appendChild(o);}if(currentAyah>maxA||currentAyah<1)currentAyah=1;aS().value=currentAyah;}else{const o=document.createElement('option');o.textContent="-";aS().appendChild(o);}}}
        async function loadAyahView(suraNum, ayahNum) { if(!db1){showAlert('DB not ready.','warning');return;} currentSurah=parseInt(suraNum);currentAyah=parseInt(ayahNum); if(sS().value!=currentSurah)sS().value=currentSurah; updateAyahDropdown(); if(cSAD())cSAD().textContent=`${surahNames[currentSurah]} ${currentSurah}:${currentAyah}`; const tx=db1.transaction(WORDS_STORE,'readonly');const st=tx.objectStore(WORDS_STORE);const idx=st.index('s_a_p'); const rg=IDBKeyRange.bound([currentSurah,currentAyah,0],[currentSurah,currentAyah,Infinity]); wordDataForTooltips=[]; idx.openCursor(rg).onsuccess=e=>{const cur=e.target.result; if(cur){wordDataForTooltips.push(cur.value);cur.continue();}else{wordDataForTooltips.sort((a,b)=>a.position-b.position); displayAyahArabicWithTooltips(wordDataForTooltips); displayWordByWord(wordDataForTooltips); generateAndDisplayAyahTranslations(wordDataForTooltips); loadNote(); updateBookmarkButtonStatus(); updateAudioPlayerSource(); calculateSurahStats(currentSurah);}}; tx.onerror=e=>_err('Fetch ayah error: '+e.target.error);}
        function displayAyahArabicWithTooltips(words){ const cont = aATTCont(); if(!cont) return; cont.innerHTML = ''; words.forEach((word, index) => { const span = document.createElement('span'); span.className = 'arabic-word-tooltipable'; span.textContent = word.quran_text + (index < words.length - 1 ? ' ' : ''); span.dataset.wordIndex = index; cont.appendChild(span); new bootstrap.Tooltip(span, { title: `<div class="tooltip-english">EN: ${word.en_meaning || 'N/A'}</div><div class="tooltip-urdu">UR: ${word.ur_meaning || 'N/A'}</div>`, html: true, placement: 'bottom', boundary: 'viewport', customClass: 'quran-word-tooltip' }); });}
        function displayWordByWord(words){ if(!wTB())return; wTB().innerHTML=''; if(words.length===0){wTB().innerHTML='<tr><td colspan="3">No data.</td></tr>';return;} words.forEach(w=>{const r=wTB().insertRow();r.insertCell().textContent=w.quran_text;r.cells[0].classList.add('arabic-word');r.insertCell().textContent=w.ur_meaning;r.cells[1].classList.add('urdu-word');r.insertCell().textContent=w.en_meaning;});}
        function generateAndDisplayAyahTranslations(words){ let enT=words.map(w=>w.en_meaning.replace(/[()]/g,'')).join(' ').trim(); let urT=words.map(w=>w.ur_meaning.replace(/[()]/g,'')).join(' ').trim(); if(enT)enT=enT.charAt(0).toUpperCase()+enT.slice(1)+'.';else enT="N/A."; if(urT)urT+='۔';else urT="N/A"; if(eT())eT().textContent=enT; if(uT())uT().textContent=urT;}
        function toggleAyahIndexView(){ayahIndexState.isActive=!ayahIndexState.isActive;if(aIVC())aIVC().style.display=ayahIndexState.isActive?'block':'none';if(tAIBtn())tAIBtn().textContent=ayahIndexState.isActive?'Hide Quran Index':'Show Quran Index';if(ayahIndexState.isActive&&totalGlobalAyahs>0){ayahIndexState.totalPages=Math.ceil(totalGlobalAyahs/ayahIndexState.itemsPerPage);renderAyahIndexPage(ayahIndexState.currentPage);}}
        function renderAyahIndexPage(page){if(!db1||!aIList()||!aIPInfo())return; ayahIndexState.currentPage=Math.max(1,Math.min(page,ayahIndexState.totalPages));aIList().innerHTML='';const sGI=(ayahIndexState.currentPage-1)*ayahIndexState.itemsPerPage+1;const eGI=Math.min(sGI+ayahIndexState.itemsPerPage-1,totalGlobalAyahs);for(let i=sGI;i<=eGI;i++){const item=getSurahAyahFromGlobalIndex(i);if(item){const li=document.createElement('li');li.className='list-group-item list-group-item-action list-group-item-sm py-1';li.textContent=`${surahNames[item.surah]} ${item.surah}:${item.ayah} (Global: ${i})`;li.dataset.surah=item.surah;li.dataset.ayah=item.ayah;li.onclick=()=>{loadAyahView(item.surah,item.ayah);gebi('ayahViewPage').scrollTop=0;};aIList().appendChild(li);}}aIPInfo().textContent=`Page ${ayahIndexState.currentPage} of ${ayahIndexState.totalPages}`;if(prevAIPBtn())prevAIPBtn().disabled=ayahIndexState.currentPage===1;if(nextAIPBtn())nextAIPBtn().disabled=ayahIndexState.currentPage===ayahIndexState.totalPages;}
        function setupMushafView() {const mode=mVMSel()?mVMSel().value:'singleSurah';if(mode==='singleSurah'){mushafContinuousState.isActive=false;if(mushafIntersectionObserver)mushafIntersectionObserver.disconnect();if(mSSC())mSSC().style.display='block';if(qFV()){qFV().className='arabic-text block-style';let sentinel=gebi('mushafSentinel');if(sentinel)sentinel.remove(); /* Remove sentinel if exists from flow mode */}loadSingleMushafSurah(parseInt(mSS().value)||1);}else{mushafContinuousState.isActive=true;if(mSSC())mSSC().style.display='none';if(mFSN())mFSN().textContent="Full Quran View";if(qFV()){qFV().innerHTML='';qFV().className='arabic-text flow-style';let sentinel=gebi('mushafSentinel');if(!sentinel){sentinel=document.createElement('div');sentinel.id='mushafSentinel';}qFV().appendChild(sentinel);_log("Sentinel ensured for fullQuran mode.");}resetMushafContinuousState();initializeMushafIntersectionObserver();loadNextMushafChunk(true);}}
        function resetMushafContinuousState(){mushafContinuousState.currentSurah=1;mushafContinuousState.currentAyahInSurah=0;mushafContinuousState.globalAyahsRendered=0;mushafContinuousState.isLoadingChunk=false;mushafContinuousState.allAyahsRendered=false;if(qFV())qFV().scrollTop=0;}
        async function loadSingleMushafSurah(suraNum){if(!db1||!qFV())return;qFV().innerHTML='<div class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"></div><p class="small mt-1">Loading Surah...</p></div>';if(mFSN())mFSN().textContent=surahNamesArabic[suraNum]?`${surahNamesArabic[suraNum]}`:'';const tx=db1.transaction(WORDS_STORE,'readonly');const st=tx.objectStore(WORDS_STORE);const idx=st.index('s_a_p');const rg=IDBKeyRange.bound([suraNum,0,0],[suraNum,Infinity,Infinity]);const ayahs={};idx.openCursor(rg).onsuccess=e=>{const cur=e.target.result;if(cur){const w=cur.value;if(!ayahs[w.ayah])ayahs[w.ayah]=[];ayahs[w.ayah].push({text:w.quran_text,position:w.position});cur.continue();}else{for(const an in ayahs){ayahs[an]=ayahs[an].sort((a,b)=>a.position-b.position).map(w=>w.text).join(' ');}renderSingleSurahMushaf(ayahs,suraNum);}};tx.onerror=e=>{_err('Fetch single surah error: '+e.target.error);if(qFV())qFV().innerHTML='<p class="text-danger p-3 small">Error loading Surah.</p>';};}
        function renderSingleSurahMushaf(ayahsData,suraNum){if(!qFV())return;qFV().innerHTML='';qFV().className='arabic-text block-style';if(Object.keys(ayahsData).length===0&&suraNum){qFV().innerHTML=`<p class="p-3 small">No text for Surah ${surahNames[suraNum]}.</p>`;return;}if(suraNum!==1&&suraNum!==9){const bd=document.createElement('div');bd.className='bismillah-text-mushaf arabic-text';bd.textContent=BISMILLAH_TEXT;qFV().appendChild(bd);}const frag=document.createDocumentFragment();const sortedANs=Object.keys(ayahsData).map(Number).sort((a,b)=>a-b);for(const an of sortedANs){const at=ayahsData[an];const ad=document.createElement('div');ad.className='ayah-block';const ts=document.createElement('span');ts.className='ayah-text-mushaf';ts.textContent=at;const ns=document.createElement('span');ns.className='ayah-number-mushaf';ns.textContent=`﴿${an.toLocaleString('ar-EG')}﴾`;ad.appendChild(ts);ad.appendChild(ns);frag.appendChild(ad);}qFV().appendChild(frag);applyMushafFontSize();}
        async function loadNextMushafChunk(isInitialLoad=false){if(!db1||mushafContinuousState.isLoadingChunk||mushafContinuousState.allAyahsRendered||!mushafContinuousState.isActive){_log("loadNextMushafChunk SKIPPED:",{isActive:mushafContinuousState.isActive,isLoading:mushafContinuousState.isLoadingChunk,allRendered:mushafContinuousState.allAyahsRendered});return;}mushafContinuousState.isLoadingChunk=true;_log(`loadNextMushafChunk START. Initial:${isInitialLoad}. State:S${mushafContinuousState.currentSurah}:A${mushafContinuousState.currentAyahInSurah},Rendered:${mushafContinuousState.globalAyahsRendered}`);try{let ayahsToRenderElements=[];let ayahsCountInChunk=0;let tempCS=mushafContinuousState.currentSurah;let tempCAIS=mushafContinuousState.currentAyahInSurah;const tx=db1.transaction(WORDS_STORE,'readonly');const st=tx.objectStore(WORDS_STORE);const idx=st.index('s_a_p');if(isInitialLoad&&tempCS===1&&tempCAIS===0){const sh=document.createElement('div');sh.className='surah-header-mushaf arabic-text';sh.textContent=`${surahNamesArabic[1]} (${surahNames[1]})`;ayahsToRenderElements.push({type:'surahHeader',element:sh});}while(tempCS<=114&&ayahsCountInChunk<MUSHAF_CHUNK_SIZE){if(tempCAIS===0){if(!isInitialLoad||tempCS>1||(isInitialLoad && tempCS > 1)){const sh=document.createElement('div');sh.className='surah-header-mushaf arabic-text';sh.textContent=`${surahNamesArabic[tempCS]} (${surahNames[tempCS]})`;ayahsToRenderElements.push({type:'surahHeader',element:sh});}if(tempCS!==1&&tempCS!==9){const bd=document.createElement('div');bd.className='bismillah-text-mushaf arabic-text';bd.textContent=BISMILLAH_TEXT;ayahsToRenderElements.push({type:'bismillah',element:bd});}}tempCAIS++;if(tempCAIS>surahMaxAyahs[tempCS]){tempCS++;tempCAIS=0;if(tempCS>114){mushafContinuousState.allAyahsRendered=true;break;}continue;}const rg=IDBKeyRange.bound([tempCS,tempCAIS,0],[tempCS,tempCAIS,Infinity]);const ayahWordsText=await new Promise((rW,rjW)=>{const tw=[];const cr=idx.openCursor(rg);cr.onsuccess=e=>{const cur=e.target.result;if(cur){tw.push(cur.value);cur.continue();}else{rW(tw.sort((a,b)=>a.position-b.position).map(w=>w.quran_text).join(' '));}};cr.onerror=(e)=>{_err(`DB cursor error S${tempCS}:A${tempCAIS}`,e.target.error);rW("");};}).catch(err=>{_err(`Error processing words S${tempCS}:A${tempCAIS}`,err);return"";});if(ayahWordsText){const ts=document.createElement('span');ts.className='mushaf-ayah-text-flow';ts.textContent=ayahWordsText;const ns=document.createElement('span');ns.className='mushaf-ayah-number-flow';ns.textContent=`﴿${tempCAIS.toLocaleString('ar-EG')}﴾`;ayahsToRenderElements.push({type:'ayah',textEl:ts,numEl:ns});ayahsCountInChunk++;mushafContinuousState.globalAyahsRendered++;_log(`Processed S${tempCS}:A${tempCAIS}. ChunkCount:${ayahsCountInChunk}, GlobalRendered:${mushafContinuousState.globalAyahsRendered}`);}mushafContinuousState.currentSurah=tempCS;mushafContinuousState.currentAyahInSurah=tempCAIS;if(mushafContinuousState.globalAyahsRendered>=totalGlobalAyahs){mushafContinuousState.allAyahsRendered=true;break;}}_log(`loadNextMushafChunk LOOP END. Ayahs in chunk:${ayahsCountInChunk}. New State:S${mushafContinuousState.currentSurah}:A${mushafContinuousState.currentAyahInSurah},Rendered:${mushafContinuousState.globalAyahsRendered},AllRendered:${mushafContinuousState.allAyahsRendered}`);renderMushafChunk(ayahsToRenderElements);if(mushafContinuousState.allAyahsRendered&&mushafIntersectionObserver){_log("All ayahs rendered, disconnecting observer.");mushafIntersectionObserver.disconnect();}}catch(error){_err("Error in loadNextMushafChunk:",error);showAlert("Error loading more Quran text.","danger");}finally{mushafContinuousState.isLoadingChunk=false;_log("loadNextMushafChunk FINALLY. isLoadingChunk set to false.");}}
        function renderMushafChunk(elementsToRender){if(!qFV())return;const frag=document.createDocumentFragment();elementsToRender.forEach(item=>{if(item.type==='bismillah'||item.type==='surahHeader'){frag.appendChild(item.element);}else if(item.type==='ayah'){frag.appendChild(item.textEl);frag.appendChild(item.numEl);}});const sentinelNode=gebi('mushafSentinel');if(sentinelNode){qFV().insertBefore(frag,sentinelNode);}else{qFV().appendChild(frag);_warn("Sentinel not found during renderMushafChunk! Appending content anyway.");}applyMushafFontSize();}
        function initializeMushafIntersectionObserver(){if(mushafIntersectionObserver)mushafIntersectionObserver.disconnect();const options={root:qFV(),rootMargin:'300px 0px 300px 0px',threshold:0.01};mushafIntersectionObserver=new IntersectionObserver((entries)=>{_log("IntersectionObserver triggered. Entry isIntersecting:",entries[0].isIntersecting);if(entries[0].isIntersecting&&!mushafContinuousState.isLoadingChunk&&!mushafContinuousState.allAyahsRendered){_log("Sentinel visible, conditions met, calling loadNextMushafChunk...");loadNextMushafChunk();}else if(entries[0].isIntersecting){_log("Sentinel visible BUT conditions NOT met: isLoadingChunk:",mushafContinuousState.isLoadingChunk,"allAyahsRendered:",mushafContinuousState.allAyahsRendered);}},options);const sentinel=gebi('mushafSentinel');if(sentinel){mushafIntersectionObserver.observe(sentinel);_log("IntersectionObserver initialized and observing sentinel.");}else{_warn("Mushaf sentinel not found for IntersectionObserver init!");}}
        function applyMushafFontSize(){const size=mFSR()?mFSR().value:24;if(qFV()){qFV().style.fontSize=`${size}px`;qFV().style.lineHeight=`${Math.max(1.8,size/13)}`;}if(mFSV())mFSV().textContent=size;localStorage.setItem('mushafFontSize',size);document.querySelectorAll('#quranFullView .bismillah-text-mushaf, #quranFullView .surah-header-mushaf').forEach(d=>{d.style.fontSize=`${size*(d.classList.contains('surah-header-mushaf')?1.2:1)}px`;});}
        function toggleFullScreenMushaf(){const elem=qFV();if(!elem)return;if(!document.fullscreenElement){elem.requestFullscreen().catch(err=>showAlert(`Fullscreen error: ${err.message}`,'warning'));}else{if(document.exitFullscreen)document.exitFullscreen();}}
        function navigateAyah(dir){let nS=currentSurah,nA=currentAyah;if(dir==='next'){if(nA<surahMaxAyahs[nS]){nA++;}else if(nS<114){nS++;nA=1;}else{showAlert('End of Quran.','info');return;}}else if(dir==='prev'){if(nA>1){nA--;}else if(nS>1){nS--;nA=surahMaxAyahs[nS];}else{showAlert('Start of Quran.','info');return;}}loadAyahView(nS,nA);}
        async function toggleBookmark(){if(!db1)return;const saStr=formatAyahRef(currentSurah,currentAyah);const tx=db1.transaction(BOOKMARKS_STORE,'readwrite');const st=tx.objectStore(BOOKMARKS_STORE);const idx=st.index('s_a');const req=idx.get(saStr);req.onsuccess=e=>{const ex=e.target.result;if(ex){st.delete(ex.id).onsuccess=()=>{showAlert('Bookmark removed.','info');updateBookmarkButtonStatus(false);loadBookmarks();};}else{st.add({surah_ayah:saStr,surah:currentSurah,ayah:currentAyah,name:surahNames[currentSurah]}).onsuccess=()=>{showAlert('Bookmarked!','success');updateBookmarkButtonStatus(true);loadBookmarks();};}};req.onerror=e=>_err('Bookmark access error: '+e.target.error);}
        async function updateBookmarkButtonStatus(isBM){if(isBM===undefined){if(!db1||!bmBtn()){if(bmBtn()){bmBtn().textContent='Bookmark';bmBtn().classList.remove('btn-danger','active');bmBtn().classList.add('btn-warning');}return;}const saStr=formatAyahRef(currentSurah,currentAyah);const tx=db1.transaction(BOOKMARKS_STORE,'readonly');const st=tx.objectStore(BOOKMARKS_STORE);const idx=st.index('s_a');idx.get(saStr).onsuccess=e=>{const B=!!e.target.result;if(bmBtn()){bmBtn().textContent=B?'Unbookmark':'Bookmark';bmBtn().classList.toggle('btn-danger',B);bmBtn().classList.toggle('active',B);bmBtn().classList.toggle('btn-warning',!B);}};}else{if(bmBtn()){bmBtn().textContent=isBM?'Unbookmark':'Bookmark';bmBtn().classList.toggle('btn-danger',isBM);bmBtn().classList.toggle('active',isBM);bmBtn().classList.toggle('btn-warning',!isBM);}}}
        function loadBookmarks(){if(!db1||!bmList())return;const tx=db1.transaction(BOOKMARKS_STORE,'readonly');const st=tx.objectStore(BOOKMARKS_STORE);bmList().innerHTML='';st.openCursor().onsuccess=e=>{const cur=e.target.result;if(cur){const bm=cur.value;const li=document.createElement('li');li.className='list-group-item list-group-item-sm d-flex justify-content-between align-items-center py-1';li.textContent=`S${bm.surah}:${bm.ayah} (${surahNames[bm.surah]})`;li.dataset.surah=bm.surah;li.dataset.ayah=bm.ayah;li.onclick=()=>{loadAyahView(parseInt(bm.surah),parseInt(bm.ayah));const avt=gebi('ayah-view-tab');if(avt)new bootstrap.Tab(avt).show();};const delB=document.createElement('button');delB.className='btn btn-sm btn-outline-danger py-0 px-1';delB.innerHTML='&times;';delB.setAttribute('aria-label','Remove');delB.onclick=ev=>{ev.stopPropagation();removeBookmark(bm.id);};li.appendChild(delB);bmList().appendChild(li);cur.continue();}else{if(bmList().children.length===0)bmList().innerHTML='<li class="list-group-item list-group-item-sm py-1">No bookmarks.</li>';}};}
        function removeBookmark(bmId){if(!db1)return;const tx=db1.transaction(BOOKMARKS_STORE,'readwrite');tx.objectStore(BOOKMARKS_STORE).delete(bmId).onsuccess=()=>{showAlert('Bookmark removed.','info');loadBookmarks();updateBookmarkButtonStatus();};}
        function loadNote(){if(!db1)return;const saStr=formatAyahRef(currentSurah,currentAyah);if(nAI())nAI().textContent=`${surahNames[currentSurah]} (${saStr})`;const tx=db1.transaction(NOTES_STORE,'readonly');tx.objectStore(NOTES_STORE).get(saStr).onsuccess=e=>{if(nTxt())nTxt().value=e.target.result?e.target.result.text:'';};}
        function saveNote(){if(!db1)return;const saStr=formatAyahRef(currentSurah,currentAyah);const text=nTxt()?nTxt().value.trim():"";const tx=db1.transaction(NOTES_STORE,'readwrite');const st=tx.objectStore(NOTES_STORE);if(text){st.put({surah_ayah:saStr,text:text}).onsuccess=()=>showAlert('Note saved!','success');}else{st.delete(saStr).onsuccess=()=>showAlert('Note cleared.','info');}tx.onerror=e=>showAlert('Note save error: '+e.target.error.message,'danger');}
        async function performSearch(){if(!db1){showAlert('DB not ready.','warning');return;}const query=srchIn()?srchIn().value.trim():"";if(!query){if(srchResList())srchResList().innerHTML='';if(srchResInfo())srchResInfo().textContent='Enter search term.';return;}if(srchSpin())srchSpin().style.display='block';if(srchResList())srchResList().innerHTML='';if(srchResInfo())srchResInfo().textContent='Searching...';const saMatch=query.match(/^(\d{1,3}):(\d{1,3})$/);if(saMatch){const s=parseInt(saMatch[1]),a=parseInt(saMatch[2]);if(s>0&&s<=114&&a>0&&a<=surahMaxAyahs[s]){if(srchSpin())srchSpin().style.display='none';if(srchResInfo())srchResInfo().textContent=`Navigating S${s}:A${a}.`;loadAyahView(s,a);const avt=gebi('ayah-view-tab');if(avt)new bootstrap.Tab(avt).show();return;}else{if(srchSpin())srchSpin().style.display='none';if(srchResInfo())srchResInfo().textContent='Invalid S:A.';return;}}const results=new Map();const lQ=query.toLowerCase();const nAQ=removeArabicDiacritics(query);const tx=db1.transaction(WORDS_STORE,'readonly');const st=tx.objectStore(WORDS_STORE);let iS=0,mF=0;st.openCursor().onsuccess=e=>{const cur=e.target.result;if(cur){iS++;const w=cur.value;const saK=formatAyahRef(w.surah,w.ayah);if(!results.has(saK)){if((w.quran_text&&removeArabicDiacritics(w.quran_text).includes(nAQ))||(w.ur_meaning&&w.ur_meaning.toLowerCase().includes(lQ))||(w.en_meaning&&w.en_meaning.toLowerCase().includes(lQ))){results.set(saK,w);mF++;}}if(iS%5000===0){if(srchResInfo())srchResInfo().textContent=`Scanned ${iS}, Found ${mF}...`;}cur.continue();}else{if(srchSpin())srchSpin().style.display='none';if(results.size>0){if(srchResInfo())srchResInfo().textContent=`Found ${results.size} ayahs for "${query}".`;results.forEach((w,key)=>{const[s,a]=key.split(':').map(Number);const li=document.createElement('li');li.className='list-group-item list-group-item-sm search-results-item py-1';let ctx=w.quran_text;if(w.en_meaning&&w.en_meaning.toLowerCase().includes(lQ))ctx=w.en_meaning;else if(w.ur_meaning&&w.ur_meaning.toLowerCase().includes(lQ))ctx=w.ur_meaning;li.textContent=`S${s}:${a} (${surahNames[s]}) - "...${ctx.substring(0,30)}..."`;li.dataset.surah=s;li.dataset.ayah=a;li.onclick=()=>{loadAyahView(s,a);const avt=gebi('ayah-view-tab');if(avt)new bootstrap.Tab(avt).show();};if(srchResList())srchResList().appendChild(li);});}else{if(srchResInfo())srchResInfo().textContent=`No results for "${query}". Scanned ${iS}.`;}}};tx.onerror=e=>{_err('Search error: '+e.target.error);if(srchSpin())srchSpin().style.display='none';if(srchResInfo())srchResInfo().textContent='Search error.';showAlert('Search error: '+e.target.error.message,'danger');};}
        function updateAudioPlayerSource(){const apiUrl=`https://api.alquran.cloud/v1/ayah/${currentSurah}:${currentAyah}/ar.alafasy`;fetch(apiUrl).then(r=>r.json()).then(d=>{if(d.code===200&&d.data.audio){if(audPlyr())audPlyr().src=d.data.audio;}else{_warn('Audio not found:',d.status);if(audPlyr())audPlyr().removeAttribute('src');showAlert('Audio not loaded.','warning');}}).catch(err=>{_err('Fetch audio error:',err);if(audPlyr())audPlyr().removeAttribute('src');showAlert('Fetch audio failed.','danger');});}
        function exportAyahTranslations(){const enT=eT()?eT().textContent:"N/A";const urT=uT()?uT().textContent:"N/A";let ayahArText=wordDataForTooltips.map(w=>w.quran_text).join(' ');let content=`Ayah: ${surahNames[currentSurah]} ${currentSurah}:${currentAyah}\nArabic: ${ayahArText}\n\nEnglish:\n${enT}\n\nUrdu:\n${urT}\n\n`;const words=[];if(wTB()){const rows=wTB().rows;for(let i=0;i<rows.length;i++){words.push({ar:rows[i].cells[0]?rows[i].cells[0].textContent:"",ur:rows[i].cells[1]?rows[i].cells[1].textContent:"",en:rows[i].cells[2]?rows[i].cells[2].textContent:""});}}if(words.length>0){content+="Word by Word:\nArabic | Urdu | English\n---------------------------\n";words.forEach(w=>{content+=`${w.ar} | ${w.ur} | ${w.en}\n`;});}const blob=new Blob([content],{type:'text/plain;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`quran_ayah_${currentSurah}_${currentAyah}.txt`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(a.href);showAlert('Ayah data exported.','success');}
        async function calculateSurahStats(suraNum){if(!db1){if(sStats())sStats().textContent='DB not ready.';return;}const tx=db1.transaction(WORDS_STORE,'readonly');const st=tx.objectStore(WORDS_STORE);const idx=st.index('s');const rg=IDBKeyRange.only(parseInt(suraNum));const countReq=idx.count(rg);countReq.onsuccess=()=>{const wc=countReq.result;if(sStats())sStats().textContent=`Surah ${surahNames[suraNum]} has ${surahMaxAyahs[suraNum]} ayahs, ${wc} words.`;};countReq.onerror=e=>{_err('Stats count error: '+e.target.error);if(sStats())sStats().textContent='Stats error.';};}
        function applySettings(){const sfs=localStorage.getItem('mushafFontSize');if(sfs&&mFSR()){mFSR().value=sfs;}applyMushafFontSize();const swbw=localStorage.getItem('showWordByWord')!=='false';const sat=localStorage.getItem('showAyahTranslation')!=='false';if(sWByWToggle())sWByWToggle().checked=swbw;if(sATToggle())sATToggle().checked=sat;if(wByWView())wByWView().style.display=swbw?'':'none';if(aTView())aTView().style.display=sat?'':'none';const st=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-bs-theme',st);}
        function clearAllData(){if(confirm("Clear all local data? App will reload.")){if(lI()){lI().innerHTML='<div class="spinner-border spinner-border-sm"></div><p class="small mt-1">Clearing...</p>';lI().style.display='flex';}const dr=indexedDB.deleteDatabase(DB_NAME);dr.onsuccess=()=>{localStorage.clear();showAlert('Data cleared. Reloading...','info');setTimeout(()=>window.location.reload(),2000);};dr.onerror=e=>{_err("Delete DB error:",e.target.error);showAlert('Error clearing data.','danger');if(lI())lI().style.display='none';};dr.onblocked=()=>{_warn("DB delete blocked.");showAlert('Deletion blocked. Close tabs.','warning');if(lI())lI().style.display='none';};}}
        window.onload=async()=>{try{await initDB();await checkAndLoadInitialData();}catch(err){_err("Init failed:",err);showAlert('App init failed.','danger');if(lI())lI().style.display='none';}if(sS())sS().onchange=()=>{loadAyahView(parseInt(sS().value),1);};if(aS())aS().onchange=()=>{loadAyahView(currentSurah,parseInt(aS().value));};const pb=gebi('prevAyahBtn');if(pb)pb.onclick=()=>navigateAyah('prev');const nb=gebi('nextAyahBtn');if(nb)nb.onclick=()=>navigateAyah('next');if(bmBtn())bmBtn().onclick=toggleBookmark;if(sNBtn())sNBtn().onclick=saveNote;if(pABtn()&&audPlyr())pABtn().onclick=()=>audPlyr().play().catch(e=>showAlert("Audio play failed.","warning"));const expB=gebi('exportAyahBtn');if(expB)expB.onclick=exportAyahTranslations;if(srchBtn())srchBtn().onclick=performSearch;if(srchIn())srchIn().onkeyup=e=>{if(e.key==='Enter')performSearch();};if(tAIBtn())tAIBtn().onclick=toggleAyahIndexView;if(prevAIPBtn())prevAIPBtn().onclick=()=>{if(ayahIndexState.currentPage>1)renderAyahIndexPage(ayahIndexState.currentPage-1);};if(nextAIPBtn())nextAIPBtn().onclick=()=>{if(ayahIndexState.currentPage<ayahIndexState.totalPages)renderAyahIndexPage(ayahIndexState.currentPage+1);};if(mVMSel())mVMSel().onchange=setupMushafView;if(mSS())mSS().onchange=()=>{if(mVMSel().value==='singleSurah')loadSingleMushafSurah(parseInt(mSS().value));};if(tFSBtn())tFSBtn().onclick=toggleFullScreenMushaf;if(mFSR()){mFSR().oninput=applyMushafFontSize;mFSR().onchange=applyMushafFontSize;}if(sWByWToggle())sWByWToggle().onchange=e=>{if(wByWView())wByWView().style.display=e.target.checked?'':'none';localStorage.setItem('showWordByWord',e.target.checked);};if(sATToggle())sATToggle().onchange=e=>{if(aTView())aTView().style.display=e.target.checked?'':'none';localStorage.setItem('showAyahTranslation',e.target.checked);};const tt=gebi('toggleThemeBtn');if(tt)tt.onclick=()=>{const nt=document.documentElement.getAttribute('data-bs-theme')==='dark'?'light':'dark';document.documentElement.setAttribute('data-bs-theme',nt);localStorage.setItem('theme',nt);};const cb=gebi('clearAllDataBtn');if(cb)cb.onclick=clearAllData;const mt=gebi('mainTabs');if(mt)mt.addEventListener('shown.bs.tab',e=>{const tid=e.target.getAttribute('data-bs-target');if(tid==='#bookmarksPage')loadBookmarks();else if(tid==='#mushafViewPage')setupMushafView();else if(tid==='#ayahViewPage'&&ayahIndexState.isActive)renderAyahIndexPage(ayahIndexState.currentPage);});};
    </script>
</body>
</html>